window.Poe3={};window.Poe3.browserCheck=function(){var getVersion=function(){var rv=-1;if(navigator.appName=="Microsoft Internet Explorer"){var ua=navigator.userAgent;var re=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(re.exec(ua)!=null)rv=parseFloat(RegExp.$1)}return rv};var ver=getVersion();if(ver>-1){if(ver<=9){window.location.reload("/html/browsers.html")}}};window.Poe3.browserCheck();window.Poe3.initFB=function(){(function(d){var js,id="facebook-jssdk",ref=d.getElementsByTagName("script")[0];if(d.getElementById(id)){return}js=d.createElement("script");js.id=id;js.async=true;js.src="//connect.facebook.net/en_US/all.js";ref.parentNode.insertBefore(js,ref)})(document);window.fbAsyncInit=function(){FB.init({appId:"399747530084964",channelUrl:"//"+window.location.hostname+"/channel",frictionlessRequests:false,status:true,cookie:true,xfbml:true});app.onFBLoad()}};window.Poe3.templateLoader={load:function(namespace,views,callback){if(Poe3.debugMode){var deferreds=[];$.each(views,function(index,view){if(view.view){fn=function(_view,_name){deferreds.push($.get("/templates/"+_view.templates[_name].toLowerCase()+".html",function(data){window[namespace][_view.view].prototype[_name]=Handlebars.compile(data)},"html"))};for(name in view.templates){fn(view,name)}}else{fn=function(_view){deferreds.push($.get("/templates/"+_view.toLowerCase()+".html",function(data){window[namespace][_view].prototype.template=Handlebars.compile(data)},"html"))};fn(view)}});$.when.apply(null,deferreds).done(callback)}else{$.get("/templates/templates.html",function(data){templates=$(data);$.each(views,function(index,view){if(view.view){for(name in view.templates){var i=0;var tmpl=null;for(i=0;i<templates.length;i++){if($(templates[i]).hasClass("template-"+view.templates[name].toLowerCase())){tmpl=templates[i].outerHTML;break}}if(tmpl)window[namespace][view.view].prototype[name]=Handlebars.compile(tmpl);else console.log("Template not found: "+view.templates[name])}}else{var i=0;var tmpl=null;for(i=0;i<templates.length;i++){if($(templates[i]).hasClass("template-"+view.toLowerCase())){tmpl=templates[i].outerHTML;break}}if(tmpl)window[namespace][view].prototype.template=Handlebars.compile(tmpl);else console.log("Template not found: "+view)}});callback()})}}};(function(){var BaseModel,Comment,Comments,Message,Messages,Post,Posts,User,Users,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};BaseModel=function(_super){__extends(BaseModel,_super);function BaseModel(){this.toTemplateParam=__bind(this.toTemplateParam,this);return BaseModel.__super__.constructor.apply(this,arguments)}BaseModel.prototype.toTemplateParam=function(){var result;result=this.toJSON();result._model=this;result.isAutheticated=app.isAuthenticated();return result};return BaseModel}(Backbone.Model);Post=function(_super){__extends(Post,_super);function Post(){this.shorten=__bind(this.shorten,this);this.getFontSize=__bind(this.getFontSize,this);this.validateNewPart=__bind(this.validateNewPart,this);this.countTotalWords=__bind(this.countTotalWords,this);this.countWords=__bind(this.countWords,this);this.countTotalLines=__bind(this.countTotalLines,this);this.countLines=__bind(this.countLines,this);this.isLoadedAsync=__bind(this.isLoadedAsync,this);this.sanitize=__bind(this.sanitize,this);this.canAddContent=__bind(this.canAddContent,this);this.isOpen=__bind(this.isOpen,this);this.isOwner=__bind(this.isOwner,this);this.hasContribs=__bind(this.hasContribs,this);this.getPartSelector=__bind(this.getPartSelector,this);this.getCompletionMessage=__bind(this.getCompletionMessage,this);this.getContribMessage=__bind(this.getContribMessage,this);this.getContribForm=__bind(this.getContribForm,this);this.getPartEditor=__bind(this.getPartEditor,this);this.summarizeContent=__bind(this.summarizeContent,this);this.getPostName=__bind(this.getPostName,this);this.formatType=__bind(this.formatType,this);this.formatNotes=__bind(this.formatNotes,this);this.formatAsIcon=__bind(this.formatAsIcon,this);this.getFreeVerseTitle=__bind(this.getFreeVerseTitle,this);this.formatParts=__bind(this.formatParts,this);this.format=__bind(this.format,this);this.url=__bind(this.url,this);return Post.__super__.constructor.apply(this,arguments)}Post.prototype.idAttribute="_id";Post.prototype.url=function(){if(this.id){return Poe3.apiUrl("posts/"+this.id)}else if(this.get("uid")){return Poe3.apiUrl("posts",{filter:"uid",uid:this.get("uid")})}else{return Poe3.apiUrl("posts")}};Post.prototype.format=function(viewType){if(viewType==null){viewType="full"}return this.formatParts(this.get("type"),this.get("selectedParts"),viewType)};Post.prototype.formatParts=function(type,parts,viewType){var content,lastPart,part,_i,_j,_k,_len,_len1,_len2;if(viewType==null){viewType="full"}try{if(this.isOpen()&&viewType==="full"&&this.get("createdBy").id===app.getUser().id){lastPart=parts.slice(-1)[0];switch(type){case"haiku":content="";for(_i=0,_len=parts.length;_i<_len;_i++){part=parts[_i];if(parts.length===1){content=part.content}else{if(part===lastPart){content+='<div class="last"><span class="remove-part" data-partid="'+part.id+'">Remove</span>'+part.content+"</div>"}else{content+="<div>"+part.content+"</div>"}}}content=content.replace(/\n/g,"<br />");return'<div class="post-text haiku">'+content+"</div>";case"six-word-story":content="";for(_j=0,_len1=parts.length;_j<_len1;_j++){part=parts[_j];if(parts.length===1){content=part.content}else{if(part===lastPart){content+='<span class="last"><span class="remove-part" data-partid="'+part.id+'">Remove</span>'+part.content+"</span>"}else{content+=""+part.content+" "}}}return'<p class="post-text six-word-story">'+content+"</p>";case"quote":content=parts[0].content;return'<p class="post-text quote">'+content+"</p>";case"free-verse":content="";for(_k=0,_len2=parts.length;_k<_len2;_k++){part=parts[_k];if(parts.length===1){content="<p>"+part.content+"</p>"}else{if(part===lastPart){content+='<div class="last"><span class="remove-part" data-partid="'+part.id+'">Remove</span><p>'+part.content+"</p></div>"}else{content+="<p>"+part.content+"</p>"}}}content=content.replace(/\n\n/g,"</p><p>");content=content.replace(/\n/g,"<br />");if(viewType==="full"&&this.get("title")){return'<div class="post-text free-verse"><h3 class="title">'+this.get("title")+"</h3>"+content+"</div>"}else{return'<div class="post-text free-verse">'+content+"</div>"}}}else{switch(type){case"haiku":content=function(){var _l,_len3,_results;_results=[];for(_l=0,_len3=parts.length;_l<_len3;_l++){part=parts[_l];_results.push(part.content)}return _results}().join("\n");content=content.replace(/\n/g,"<br />");return'<p class="post-text haiku">'+content+"</p>";case"six-word-story":content=function(){var _l,_len3,_results;_results=[];for(_l=0,_len3=parts.length;_l<_len3;_l++){part=parts[_l];_results.push(part.content)}return _results}().join(" ");return'<p class="post-text six-word-story">'+content+"</p>";case"quote":content=parts[0].content;return'<p class="post-text quote">'+content+"</p>";case"free-verse":content=function(){var _l,_len3,_results;_results=[];for(_l=0,_len3=parts.length;_l<_len3;_l++){part=parts[_l];_results.push("<p>"+part.content+"</p>")}return _results}().join("");content=content.replace(/\n\n/g,"</p><p>");content=content.replace(/\n/g,"<br />");if((viewType==="full"||viewType==="condensed")&&this.get("title")){return'<div class="post-text free-verse"><h3 class="title">'+this.get("title")+"</h3>"+content+"</div>"}else{return'<div class="post-text free-verse">'+content+"</div>"}}}}catch(error){return""}};Post.prototype.getFreeVerseTitle=function(){var _ref;return(_ref=this.get("title"))!=null?_ref:this.get("selectedParts")[0].content.split("\n")[0]};Post.prototype.formatAsIcon=function(){var bgcolor,content,forecolor,index,part,parts,text;if(this.get("attachmentType")==="image"){return'<div class="with-image">                <div class="container" style="background-image: url(\''+this.get("attachment")+"')\">                </div>            </div>"}else{parts=this.get("selectedParts");text=function(){switch(this.get("type")){case"haiku":content=function(){var _i,_len,_results;_results=[];for(_i=0,_len=parts.length;_i<_len;_i++){part=parts[_i];_results.push(part.content)}return _results}().join("\n");content=content.replace(/\n/g,"<br />");return'<p class="post-text haiku">'+content+"</p>";case"six-word-story":content=function(){var _i,_len,_results;_results=[];for(_i=0,_len=parts.length;_i<_len;_i++){part=parts[_i];_results.push(part.content)}return _results}().join("\n");content=content.replace(/\n/g,"<br />");return'<p class="post-text six-word-story">'+content+"</p>";case"quote":content=parts[0].content;return'<p class="post-text quote">'+content+"</p>";case"free-verse":if(this.get("title")){return'<p class="post-text free-verse">'+this.get("title")+"</p>"}else{return'<p class="post-text free-verse">'+this.getFreeVerseTitle()+"</p>"}}}.call(this);index=Poe3.getHashCode(text.slice(0,10))%6;bgcolor=["#789","#798","#879","#897","#987","#978"][index];forecolor=["#013","#031","#103","#130","#310","#301"][index];return'<div class="just-text" style="background-color:'+bgcolor+";color:"+forecolor+'">                '+text+"            </div>"}};Post.prototype.formatNotes=function(){var notes;notes=this.get("notes");if(notes){notes=notes.replace(/\n\n/g,"</p><p>");return notes.replace(/\n/g,"<br />")}};Post.prototype.formatType=function(){if(this.get("type")!=="free-verse"){return this.get("type").replace("-"," ")}else{return"poem"}};Post.prototype.getPostName=function(maxLength,prefixType){var name,part,text,type;name=function(){var _ref;switch(this.get("type")){case"haiku":type=prefixType?"Haiku ":"";name=this.shorten(this.get("selectedParts")[0].content,maxLength);return""+type+name;case"six-word-story":type=prefixType?"Six Word Story ":"";text=function(){var _i,_len,_ref,_results;_ref=this.get("selectedParts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];_results.push(part.content)}return _results}.call(this).join(" ");name=this.shorten(text,maxLength);return""+type+name;case"quote":type=prefixType?"Quote ":"";name=this.shorten(this.get("selectedParts")[0].content,maxLength);return""+type+name;case"free-verse":type=prefixType?"Free Verse ":"";name=this.shorten((_ref=this.title)!=null?_ref:this.get("selectedParts")[0].content,maxLength);return""+type+name}}.call(this);return name.replace(/,*$/,"")};Post.prototype.summarizeContent=function(type){var lines,part,parts,text;parts=this.get("selectedParts");return text=function(){var _i,_j,_len,_len1;switch(this.get("type")){case"haiku":if(type==="short"){return parts[0].content.split("\n")[0]+" ..."}else if(type==="full"){lines=[];for(_i=0,_len=parts.length;_i<_len;_i++){part=parts[_i];lines=lines.concat(part.content.split("\n"))}return lines.join("\n")}break;case"six-word-story":return function(){var _j,_len1,_results;_results=[];for(_j=0,_len1=parts.length;_j<_len1;_j++){part=parts[_j];_results.push(part.content)}return _results}().join(" ");case"quote":return parts[0].content;case"free-verse":lines=[];for(_j=0,_len1=parts.length;_j<_len1;_j++){part=parts[_j];lines=lines.concat(part.content.split("\n"))}if(lines.length>5){lines=lines.slice(0,5);lines.push(" ...")}return lines.join("\n")}}.call(this)};Post.prototype.getPartEditor=function(){var editor,partSelection;if(this.canAddContent()){editor=this.isOwner()&&this.hasContribs()?(partSelection=this.hasContribs()?this.getPartSelector():"",""+partSelection+'                <div class="section add-part" style="display:none">                    '+this.getContribForm()+"                                            </div>"):'<div class="section add-part">                    '+this.getContribForm()+"                 </div>";return editor}else{return""}};Post.prototype.getContribForm=function(){var form,part,parts,partsHtml,_i,_len;form=function(){switch(this.get("type")){case"haiku":return"<p>"+this.getContribMessage()+'<br /><textarea class="content" placeholder="Write here."></textarea></p>                 <p class="content-error hidden"></p>                 <div class="actions"><button class="submit"><i class="icon-ok"></i>Add Lines</button></div>';case"six-word-story":return"<p>"+this.getContribMessage()+'<br /><textarea class="content" placeholder="Write here."></textarea></p>                 <p class="content-error hidden"></p>                 <div class="actions"><button class="submit"><i class="icon-ok"></i>Add Words</button></div>';case"free-verse":return"<p>"+this.getContribMessage()+'<br /><textarea class="content" placeholder="Write here."></textarea></p>                 <p class="content-error hidden"></p>                 <div class="actions"><button class="submit"><i class="icon-ok"></i>Add Lines</button></div>'}}.call(this);parts=function(){var _i,_len,_ref,_results;_ref=this.get("parts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];if(part.sequence===this.get("selectedParts").length){_results.push(part)}}return _results}.call(this);if(parts.length){partsHtml="";for(_i=0,_len=parts.length;_i<_len;_i++){part=parts[_i];partsHtml+='<li>                            <img class="profile-pic" src="'+part.createdBy.thumbnail+'" alt="'+part.createdBy.name+'" />'+this.formatParts(this.get("type"),[part],"partial")+'   <div style="clear:both"></div>                        </li>'}form+='                <div class="section part-listing">                    <p>Contributions awaiting approval:</p>                    <ul>'+partsHtml+"</ul>                </div>"}return form};Post.prototype.getContribMessage=function(){var message,remaining;message=function(){switch(this.get("type")){case"haiku":remaining=3-this.countTotalLines();if(remaining===1){return"You can add the last line"}else{return"You can add one or two lines"}break;case"six-word-story":remaining=6-this.countTotalWords();if(remaining===1){return"You can add the last word"}else{return"You can add up to "+remaining+" words"}break;case"free-verse":return"Add more lines to the poem"}}.call(this);if(this.isOwner()&&this.hasContribs()){return message+', or <a href="#" class="select-contrib-link">select a contribution</a>.'}else{return""+message+"."}};Post.prototype.getCompletionMessage=function(){var canPublish,message,remaining;if(this.isOpen()&&this.isOwner()){message=function(){switch(this.get("type")){case"haiku":remaining=3-this.countTotalLines();if(remaining===0){canPublish=true;return"This haiku is ready. Make it visible by publishing it."}else{if(remaining===1){return"One more line is required to publish this."}else{return"Two more lines are required to publish this."}}break;case"six-word-story":remaining=6-this.countTotalWords();if(remaining===0){canPublish=true;return"This story is ready. Make it visible by publishing it."}else{if(remaining===1){return"One more word is required to publish this."}else{return"Add "+remaining+" words to publish this."}}break;case"free-verse":canPublish=true;return"If this poem is complete, publish it to make it visible to others."}}.call(this);if(canPublish){return{text:'<p class="text">'+message+'</p><p class="actions"><button class="publish"><i class="icon-ok"></i>Publish</button></p>',type:"success"}}else{return{text:'<p class="text">'+message+"</p>"}}}};Post.prototype.getPartSelector=function(){var html,part,parts,_i,_len;parts=function(){var _i,_len,_ref,_results;_ref=this.get("parts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];if(part.sequence===this.get("selectedParts").length){_results.push(part)}}return _results}.call(this);html="";for(_i=0,_len=parts.length;_i<_len;_i++){part=parts[_i];html+='<li class="part-select-item" data-partid="'+part.id+'">                        <img class="profile-pic" src="'+part.createdBy.thumbnail+'" alt="'+part.createdBy.name+'" />'+this.formatParts(this.get("type"),[part],"partial")+'   <div style="clear:both"></div>                    </li>'}return'<div class="section part-select-container">            <p>Choose a contribution below or <a href="#" class="write-part-link">write your own</a>.</p>            <ul>'+html+'</ul>            <div style="clear:both"></div>        </div>'};Post.prototype.hasContribs=function(){var part;return function(){var _i,_len,_ref,_results;_ref=this.get("parts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];if(part.sequence===this.get("selectedParts").length){_results.push(part)}}return _results}.call(this).length!==0};Post.prototype.isOwner=function(){return this.get("createdBy").id===app.getUser().id};Post.prototype.isOpen=function(){return this.get("state")==="open"||this.get("state")==="open-unmodifiable"};Post.prototype.canAddContent=function(){return this.isOpen()&&function(){switch(this.get("type")){case"haiku":return this.countTotalLines()<3;case"six-word-story":return this.countTotalWords()<6;case"quote":return false;case"free-verse":return true}}.call(this)};Post.prototype.sanitize=function(text){text=text.replace(/^\s+|\s+$/g,"");text=text.replace(/[ \t]{2,}/g," ");return text};Post.prototype.isLoadedAsync=function(){return this.get("attachmentType")==="image"};Post.prototype.countLines=function(text){return text.split("\n").length};Post.prototype.countTotalLines=function(){var part,sum;sum=function(a,b){return a+b};return function(){var _i,_len,_ref,_results;_ref=this.get("selectedParts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];_results.push(this.countLines(part.content))}return _results}.call(this).reduce(sum,0)};Post.prototype.countWords=function(text){return text.split(" ").length};Post.prototype.countTotalWords=function(){var part,sum;sum=function(a,b){return a+b};return function(){var _i,_len,_ref,_results;_ref=this.get("selectedParts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];_results.push(this.countWords(part.content))}return _results}.call(this).reduce(sum,0)};Post.prototype.validateNewPart=function(content){var newLines,newWords,remaining;content=this.sanitize(content);if(!content){return{isValid:false,error:"You haven't written anything."}}else{if(this.get("type")==="haiku"){remaining=3-this.countTotalLines();newLines=this.countLines(content);if(!(newLines<=remaining)){if(remaining===1){return{isValid:false,error:"A Haiku has three lines, and two lines have already been written. You may only write the last."}}else{return{isValid:false,error:"A Haiku has three lines, and one line has already been written. You may write the last two."}}}}else if(this.get("type")==="six-word-story"){remaining=6-this.countTotalWords();newWords=this.countWords(content);if(!(newWords<=remaining)){if(remaining===1){return{isValid:false,error:"A Six Word Story has six words, and five words have already been written. You may only write the last word."}}else if(remaining===5){return{isValid:false,error:"A Six Word Story has six words, and one word has already been written. You may only write five words."}}else{return{isValid:false,error:"A Six Word Story has six words, and "+toWords(this.countTotalWords())+" words have already been written. You may only write "+remaining+" words."}}}}return{isValid:true}}};Post.prototype.getFontSize=function(containerSize){var charCount,line,lineCount,maxLength,part,_i,_j,_len,_len1,_ref,_ref1;maxLength=0;lineCount=0;charCount=0;_ref=this.get("selectedParts");for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];_ref1=part.content.split("\n");for(_j=0,_len1=_ref1.length;_j<_len1;_j++){line=_ref1[_j];lineCount++;charCount+=line.length;if(line.length>maxLength){maxLength=line.length}}}if(lineCount>10||charCount>180){16}if(this.get("type")==="quote"){24}if(lineCount>8){return 14}else if(lineCount>3){if(maxLength>50){return 16}else if(maxLength>30){return 18}else{return 20}}else{if(maxLength>50){return 18}else if(maxLength>30){return 20}else{return 22}}};Post.prototype.shorten=function(text,length){var lines;lines=text.split("\n");if(length&&lines[0].length>length){return lines[0].substring(0,length)+"..."}else{return lines[0]}};return Post}(BaseModel);window.Poe3.Post=Post;Posts=function(_super){__extends(Posts,_super);function Posts(){this.url=__bind(this.url,this);return Posts.__super__.constructor.apply(this,arguments)}Posts.prototype.model=Post;Posts.prototype.url=function(){return Poe3.apiUrl("posts")};return Posts}(Backbone.Collection);Post.collection=Poe3.Posts;window.Poe3.Posts=Posts;User=function(_super){__extends(User,_super);function User(){this.isFollowedBy=__bind(this.isFollowedBy,this);this.url=__bind(this.url,this);return User.__super__.constructor.apply(this,arguments)}User.prototype.url=function(){if(this.id){return Poe3.apiUrl("users/"+this.id)}else if(this.get("domain")&&this.get("username")){return Poe3.apiUrl("users",{domain:this.get("domain"),username:this.get("username")})}};User.prototype.isFollowedBy=function(userid){var follower,matching;matching=function(){var _i,_len,_ref,_results;_ref=this.get("followers");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){follower=_ref[_i];if(follower.id===userid){_results.push(follower)}}return _results}.call(this);return matching.length!==0};return User}(BaseModel);window.Poe3.User=User;Users=function(_super){__extends(Users,_super);function Users(){this.url=__bind(this.url,this);return Users.__super__.constructor.apply(this,arguments)}Users.prototype.model=User;Users.prototype.url=function(){return Poe3.apiUrl("users")};return Users}(Backbone.Collection);User.collection=Poe3.Users;window.Poe3.Users=Users;Comment=function(_super){__extends(Comment,_super);function Comment(){return Comment.__super__.constructor.apply(this,arguments)}return Comment}(BaseModel);window.Poe3.Comment=Comment;Comments=function(_super){__extends(Comments,_super);function Comments(){this.url=__bind(this.url,this);return Comments.__super__.constructor.apply(this,arguments)}Comments.prototype.model=Comment;Comments.prototype.url=function(){if(this.postid){return Poe3.apiUrl("posts/"+this.postid+"/comments")}else{throw"The postid property is not defined for this Messages instance."}};return Comments}(Backbone.Collection);window.Poe3.Comments=Comments;Message=function(_super){__extends(Message,_super);function Message(){this.toHtml=__bind(this.toHtml,this);return Message.__super__.constructor.apply(this,arguments)}Message.prototype.idAttribute="_id";Message.prototype.toHtml=function(viewType){var data,joined,post,user,what,_ref;if(viewType==null){viewType="full"}data=this.get("data");switch(this.get("reason")){case"new-user":user=new Poe3.User(data.user);switch(this.get("type")){case"global-notification":joined=((_ref=data.location)!=null?_ref.name:void 0)?"joined from "+data.location.name:"joined";return'                        <div class="message-body">                            <a href="/'+user.get("domain")+"/"+user.get("username")+'"><img src="'+user.get("thumbnail")+'" alt="'+user.get("name")+'" /></a>                            <p>                                <a href="/'+user.get("domain")+"/"+user.get("username")+'">'+user.get("name")+"</a> "+joined+".                            </p>                        </div>"}break;case"new-post":post=new Poe3.Post(data.post);switch(this.get("type")){case"global-notification":if(post.get("authoringMode")==="collaborative"){what='Started <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>."}else{what='Completed <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>."}return'                        <div class="message-body">                            <a href="/'+post.get("createdBy").domain+"/"+post.get("createdBy").username+'"><img src="'+post.get("createdBy").thumbnail+'" alt="'+post.get("createdBy").name+'" /></a>                            <p>                                '+what+"                            </p>                        </div>"}break;case"part-contribution":post=new Poe3.Post(data.post);switch(this.get("type")){case"user-notification":switch(viewType){case"full":return'                                <div class="message-body">                                          <p>                                        Contributed to <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+'</a>                                    </p>                                    <p class="subtext">                                        '+post.shorten(data.part.content,300)+"                                    </p>                                </div>";case"condensed":return'                                <div class="message-body">                                          <a href="/'+data.part.createdBy.domain+"/"+data.part.createdBy.username+'"><img src="'+data.part.createdBy.thumbnail+'" alt="'+data.part.createdBy.name+'" /></a>                                     <p>                                        contributed to <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>                                    </p>                                </div>"}break;case"global-notification":switch(viewType){case"condensed":return'                                <div class="message-body">                                          <a href="/'+data.part.createdBy.domain+"/"+data.part.createdBy.username+'"><img src="'+data.part.createdBy.thumbnail+'" alt="'+data.part.createdBy.name+'" /></a>                                     <p>                                        contributed to <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>                                    </p>                                </div>"}}break;case"liked-post":post=new Poe3.Post(data.post);switch(this.get("type")){case"user-notification":switch(viewType){case"full":return'                                <div class="message-body">                                          <p>                                        Likes <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>                                    </p>                                </div>";case"condensed":return'                                <div class="message-body">                                          <a href="/'+this.get("from").domain+"/"+this.get("from").username+'"><img src="'+this.get("from").thumbnail+'" alt="'+this.get("from").name+'" /></a>                                     <p>                                        likes <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>                                    </p>                                </div>"}}break;case"added-comment":post=new Poe3.Post(data.post);switch(this.get("type")){case"user-notification":switch(viewType){case"full":return'                                <div class="message-body">                                          <p>                                        Commented on <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+'</a>                                    </p>                                    <p class="subtext">                                        '+post.shorten(data.comment.content,300)+"                                    </p>                                </div>";case"condensed":return'                                <div class="message-body">                                          <a href="/'+data.comment.createdBy.domain+"/"+data.comment.createdBy.username+'"><img src="'+data.comment.createdBy.thumbnail+'" alt="'+data.comment.createdBy.name+'" /></a>                                     <p>                                        commented on <a href="/'+post.get("uid")+'">'+post.getPostName(56,false)+"</a>                                    </p>                                </div>"}}break;case"new-follower":switch(this.get("type")){case"user-notification":switch(viewType){case"full":return'                                <div class="message-body">                                          <p>                                        Started following you.                                    </p>                                </div>';case"condensed":return'                                <div class="message-body">                                          <a href="/'+this.get("from").domain+"/"+this.get("from").username+'"><img src="'+this.get("from").thumbnail+'" alt="'+this.get("from").name+'" /></a>                                     <p>                                        started following you.                                    </p>                                </div>'}}break;case"promo-internal":return data;default:return""}};return Message}(BaseModel);window.Poe3.Message=Message;Messages=function(_super){__extends(Messages,_super);function Messages(){this.url=__bind(this.url,this);return Messages.__super__.constructor.apply(this,arguments)}Messages.prototype.model=Message;Messages.prototype.url=function(){if(this.userid){return Poe3.apiUrl("users/"+this.userid+"/messages")}else{throw"The userid property is not defined for this Messages instance."}};return Messages}(Backbone.Collection);User.collection=Poe3.Messages;window.Poe3.Messages=Messages}).call(this);(function($){$.fn.lightbox_me=function(options){return this.each(function(){var opts=$.extend({},$.fn.lightbox_me.defaults,options),$overlay=$(),$self=$(this),$iframe=$('<iframe id="foo" style="z-index: '+(opts.zIndex+1)+';border: none; margin: 0; padding: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; filter: mask();"/>'),ie6=$.browser.msie&&$.browser.version<7;if(opts.showOverlay){var $currentOverlays=$(".js_lb_overlay:visible");if($currentOverlays.length>0){$overlay=$('<div class="lb_overlay_clear js_lb_overlay"/>')}else{$overlay=$('<div class="'+opts.classPrefix+'_overlay js_lb_overlay"/>')}opts.lightboxReference.overlay=$overlay;opts.lightboxReference.setOverlayHeight=setOverlayHeight}if(ie6){var src=/^https/i.test(window.location.href||"")?"javascript:false":"about:blank";$iframe.attr("src",src);$("body").append($iframe)}$("body").append($self.hide()).append($overlay);if(opts.showOverlay){setOverlayHeight();$overlay.css({position:"absolute",width:"100%",top:0,left:0,right:0,bottom:0,zIndex:opts.zIndex+2,display:"none"});if(!$overlay.hasClass("lb_overlay_clear")){$overlay.css(opts.overlayCSS)}}if(opts.showOverlay){$overlay.fadeIn(opts.overlaySpeed,function(){setSelfPosition();$self[opts.appearEffect](opts.lightboxSpeed,function(){setOverlayHeight();setSelfPosition();opts.onLoad()})})}else{setSelfPosition();$self[opts.appearEffect](opts.lightboxSpeed,function(){opts.onLoad()})}if(opts.parentLightbox){opts.parentLightbox.fadeOut(200)}$(window).resize(setOverlayHeight).resize(setSelfPosition).scroll(setSelfPosition);$(window).bind("keyup.lightbox_me",observeKeyPress);if(opts.closeClick){$overlay.click(function(e){closeLightbox();e.preventDefault})}$self.delegate(opts.closeSelector,"click",function(e){closeLightbox();e.preventDefault()});$self.bind("close",closeLightbox);$self.bind("reposition",setSelfPosition);function closeLightbox(){result=opts.onClose.apply(this,arguments);if(result.close===true){var s=$self[0].style;if(opts.destroyOnClose){$self.add($overlay).remove()}else{$self.add($overlay).hide()}if(opts.parentLightbox){opts.parentLightbox.fadeIn(200)}$iframe.remove();$self.undelegate(opts.closeSelector,"click");$(window).unbind("reposition",setOverlayHeight);$(window).unbind("reposition",setSelfPosition);$(window).unbind("scroll",setSelfPosition);$(window).unbind("keyup.lightbox_me");if(ie6)s.removeExpression("top");if(result.afterClose)result.afterClose()}}function observeKeyPress(e){if((e.keyCode==27||e.DOM_VK_ESCAPE==27&&e.which==0)&&opts.closeEsc)closeLightbox()}function setOverlayHeight(){if($(window).height()<$(document).height()){$overlay.css({height:$(document).height()+"px"});$iframe.css({height:$(document).height()+"px"})
}else{$overlay.css({height:"100%"});if(ie6){$("html,body").css("height","100%");$iframe.css("height","100%")}}}function setSelfPosition(){var s=$self[0].style;$self.css({left:"50%",marginLeft:$self.outerWidth()/2*-1,zIndex:opts.zIndex+3});if($self.height()+80>=$(window).height()&&($self.css("position")!="absolute"||ie6)){var topOffset=$(document).scrollTop()+40;$self.css({position:"absolute",top:topOffset+"px",marginTop:0});if(ie6){s.removeExpression("top")}}else if($self.height()+80<$(window).height()){if(ie6){s.position="absolute";if(opts.centered){s.setExpression("top",'(document.documentElement.clientHeight || document.body.clientHeight) / 2 - (this.offsetHeight / 2) + (blah = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"');s.marginTop=0}else{var top=opts.modalCSS&&opts.modalCSS.top?parseInt(opts.modalCSS.top):0;s.setExpression("top","((blah = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "+top+') + "px"')}}else{if(opts.centered){$self.css({position:"fixed",top:"50%",marginTop:$self.outerHeight()/2*-1})}else{$self.css({position:"fixed"}).css(opts.modalCSS)}}}}})};$.fn.lightbox_me.defaults={appearEffect:"fadeIn",appearEase:"",overlaySpeed:250,lightboxSpeed:300,closeSelector:".close",closeClick:true,closeEsc:true,destroyOnClose:false,showOverlay:true,parentLightbox:false,onLoad:function(){},onClose:function(){return{close:true}},classPrefix:"lb",zIndex:999,centered:false,modalCSS:{top:"40px"},overlayCSS:{background:"black",opacity:.8}}})(jQuery);(function(){var Layout,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Layout=function(){function Layout(container,_style){var extraPerColumn;this.container=container;this.layoutElement=__bind(this.layoutElement,this);this.getOccupancy=__bind(this.getOccupancy,this);this.hasVacancy=__bind(this.hasVacancy,this);this.addOccupancy=__bind(this.addOccupancy,this);this.getVacancies=__bind(this.getVacancies,this);this.createLayout=__bind(this.createLayout,this);this.style=$.extend({},_style);this.fullWidth=this.container.width()-(this.style.marginLeft+this.style.marginRight);this.maxColumns=Math.floor((this.fullWidth+this.style.colSpacing)/(this.style.colWidth+this.style.colSpacing));this.occupiedWidth=(this.maxColumns-1)*(this.style.colWidth+this.style.colSpacing)+this.style.colWidth;if(this.style.adjustWidth){extraPerColumn=(this.fullWidth-this.occupiedWidth)/this.maxColumns;this.style.colWidth+=Math.floor(this.style.widthToSpacingRatio/(this.style.widthToSpacingRatio+1)*extraPerColumn);this.style.colSpacing+=Math.floor(1/(this.style.widthToSpacingRatio+1)*extraPerColumn)}this.colMargin=Math.floor(this.style.colSpacing/2);this.occupancyIndex=[];this.createLayout()}Layout.prototype.createLayout=function(){var col,i,_results;this.domCols=[];i=0;_results=[];while(i<this.maxColumns){if(i===0){col=$('<div class="layout-column" style="float: left; min-height: 1px; margin-left:'+this.style.marginLeft+"px; margin-right:"+this.colMargin+"px; width:"+this.style.colWidth+'px"></div>')}else if(i===this.maxColumns-1){col=$('<div class="layout-column" style="float: left; min-height: 1px; margin-left:'+this.colMargin+"px; width:"+this.style.colWidth+'px"></div>')}else{col=$('<div class="layout-column" style="float: left; min-height: 1px; margin-left:'+this.colMargin+"px; margin-right:"+this.colMargin+"px; width:"+this.style.colWidth+'px"></div>')}this.domCols.push(col);this.container.append(col);_results.push(i++)}return _results};Layout.prototype.getVacancies=function(col,height){var colOccupancy,hasItems,item,possibilities,prevListEnd,_i,_len;colOccupancy=this.getOccupancy(col);possibilities=[];prevListEnd=0;for(_i=0,_len=colOccupancy.length;_i<_len;_i++){item=colOccupancy[_i];hasItems=true;if(item.begin-prevListEnd>height){possibilities.push(prevListEnd+1)}prevListEnd=item.end}possibilities.push(hasItems?prevListEnd+1:0);return possibilities};Layout.prototype.addOccupancy=function(col,elemBegin,height,elem){var colOccupancy,index,item,nextElem,occupancy,prevElem,spacer,_i,_len;colOccupancy=this.getOccupancy(col);index=0;for(_i=0,_len=colOccupancy.length;_i<_len;_i++){item=colOccupancy[_i];if(elemBegin>item.end){if(item.elem){prevElem=item}index++}else{if(item.elem){nextElem=item;break}}}occupancy={begin:elemBegin,end:elemBegin+height};colOccupancy.splice(index,0,occupancy);if(elem){occupancy.elem=elem;if(prevElem){if(prevElem.elem.next().hasClass("layout-spacer")){prevElem.elem.next().remove()}if(occupancy.begin-prevElem.end>1){spacer=$('<div class="layout-spacer" style="width:'+this.style.colWidth+"px;height:"+(occupancy.begin-prevElem.end-1)+'px"></div>');spacer.insertAfter(prevElem.elem);elem.insertAfter(spacer)}else{elem.insertAfter(prevElem.elem)}}else{if(this.domCols[col].children().first().hasClass("layout-spacer")){this.domCols[col].children().first().remove()}if(occupancy.begin>0){spacer=$('<div class="layout-spacer" style="width:'+this.style.colWidth+"px;height:"+(occupancy.begin-1)+'px"></div>');this.domCols[col].prepend(spacer);elem.insertAfter(spacer)}else{this.domCols[col].prepend(elem)}}if(nextElem){if(nextElem.begin-occupancy.end>1){spacer=$('<div class="layout-spacer" style="width:'+this.style.colWidth+"px;height:"+(nextElem.begin-occupancy.end-1)+'px"></div>');return spacer.insertAfter(elem)}}}};Layout.prototype.hasVacancy=function(col,elemBegin,height){var colOccupancy,item,prevEnd,_i,_len;colOccupancy=this.getOccupancy(col);prevEnd=0;for(_i=0,_len=colOccupancy.length;_i<_len;_i++){item=colOccupancy[_i];if(item.begin>=elemBegin){return item.begin-prevEnd>=height}prevEnd=item.end}return prevEnd<=elemBegin};Layout.prototype.getOccupancy=function(col){if(!this.occupancyIndex[col]){this.occupancyIndex[col]=[]}return this.occupancyIndex[col]};Layout.prototype.layoutElement=function(elem){var checkingColumn,col,comparer,elemColSize,elemStartCol,firstCol,indexColumn,left,vacancies,vacancy,vacant,_i,_j,_k,_l,_len,_m,_ref,_ref1,_ref2,_ref3,_ref4;elem=$(elem);elem.addClass("layout-managed");elemColSize=parseInt(elem[0].className.match(/cols-(\d+)/)[1]);elem.css("width",elemColSize*this.style.colWidth+(elemColSize-1)*this.style.colSpacing+"px");vacancies=[];for(indexColumn=_i=0,_ref=this.maxColumns-elemColSize;0<=_ref?_i<=_ref:_i>=_ref;indexColumn=0<=_ref?++_i:--_i){firstCol=0>indexColumn-(elemColSize-1)?0:indexColumn-(elemColSize-1);_ref1=this.getVacancies(indexColumn,elem.outerHeight(true));for(_j=0,_len=_ref1.length;_j<_len;_j++){vacancy=_ref1[_j];for(elemStartCol=_k=firstCol;firstCol<=indexColumn?_k<=indexColumn:_k>=indexColumn;elemStartCol=firstCol<=indexColumn?++_k:--_k){vacant=true;for(checkingColumn=_l=elemStartCol,_ref2=elemStartCol+(elemColSize-1);elemStartCol<=_ref2?_l<=_ref2:_l>=_ref2;checkingColumn=elemStartCol<=_ref2?++_l:--_l){if(indexColumn!==checkingColumn){if(!this.hasVacancy(checkingColumn,vacancy,elem.outerHeight(true))){vacant=false;break}}}if(vacant){vacancies.push({vacancy:vacancy,elemStartCol:elemStartCol});break}}}}comparer=function(a,b){if(a.vacancy<b.vacancy){return-1}else if(a.vacancy>b.vacancy){return 1}else{return 0}};vacancies.sort(comparer);for(col=_m=_ref3=vacancies[0].elemStartCol,_ref4=vacancies[0].elemStartCol+(elemColSize-1);_ref3<=_ref4?_m<=_ref4:_m>=_ref4;col=_ref3<=_ref4?++_m:--_m){this.addOccupancy(col,vacancies[0].vacancy,elem.outerHeight(true),col===vacancies[0].elemStartCol?elem:void 0)}left=vacancies[0].elemStartCol*(this.style.colWidth+this.style.leftPadding+this.style.rightPadding+this.style.colSpacing)+this.style.left;return elem.css("display","block")};return Layout}();window.Poe3.Layout=Layout}).call(this);(function(){var LayoutHelper,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};LayoutHelper=function(){function LayoutHelper(widgetContents,style,viewportElement,widgetContainer,widgetSelector,isLoadedAsync,itemTemplate,onLayoutChange){var _ref;this.widgetContents=widgetContents;this.style=style;this.viewportElement=viewportElement;this.widgetContainer=widgetContainer;this.widgetSelector=widgetSelector;this.isLoadedAsync=isLoadedAsync;this.itemTemplate=itemTemplate;this.onLayoutChange=onLayoutChange;this.doLayout=__bind(this.doLayout,this);this.layout=new Poe3.Layout($(this.viewportElement),(_ref=this.style)!=null?_ref:{})}LayoutHelper.prototype.doLayout=function(){var bump,comparer,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad,hasAsyncWidgets,i,laidOutItems,sequence,showSyncWidgets,syncWidgetInserts,syncWidgetSequence,syncWidgets,widgetContent,x,_i,_j,_k,_len,_len1,_ref,_ref1,_ref2,_this=this;sequence=[];for(i=_i=0,_ref=this.widgetContents.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){sequence.push({order:Math.random(),index:i})}comparer=function(a,b){if(a.order<b.order){return-1}else if(a.order>b.order){return 1}else{return 0}};sequence.sort(comparer);syncWidgetInserts=function(){var _j,_len,_results;_results=[];for(i=_j=0,_len=sequence.length;_j<_len;i=++_j){x=sequence[i];if(!this.isLoadedAsync(this.widgetContents[x.index])){_results.push(i)}}return _results}.call(this);syncWidgetSequence=[];_ref1=this.widgetContents;for(_j=0,_len=_ref1.length;_j<_len;_j++){widgetContent=_ref1[_j];if(!this.isLoadedAsync(widgetContent)){syncWidgetSequence.push({insertAt:syncWidgetInserts.shift(),widgetContent:widgetContent})}else{hasAsyncWidgets=true}}fnAppend=function(html){return $(_this.widgetContainer).append(html)};laidOutItems=0;fnOnAsyncWidgetLoad=function(widgetContent){_this.layout.layoutElement($(_this.widgetSelector(widgetContent)));if(typeof _this.onLayoutChange==="function"){_this.onLayoutChange()}laidOutItems++;return showSyncWidgets()};syncWidgets=[];fnOnSyncWidgetLoad=function(widgetContent){var seq;seq=function(){var _k,_len1,_results;_results=[];for(_k=0,_len1=syncWidgetSequence.length;_k<_len1;_k++){x=syncWidgetSequence[_k];if(x.widgetContent===widgetContent){_results.push(x)}}return _results}()[0];return syncWidgets.push({widget:$(_this.widgetSelector(widgetContent)),insertAt:seq.insertAt})};showSyncWidgets=function(){var item,matching,w;matching=function(){var _k,_len1,_results;_results=[];for(_k=0,_len1=syncWidgets.length;_k<_len1;_k++){w=syncWidgets[_k];if(w.insertAt<=laidOutItems){_results.push(w)}}return _results}();if(matching.length){syncWidgets=function(){var _k,_len1,_results;_results=[];for(_k=0,_len1=syncWidgets.length;_k<_len1;_k++){w=syncWidgets[_k];if(w.insertAt>laidOutItems){_results.push(w)}}return _results}();item=matching[0];while((item!=null?item.insertAt:void 0)<=laidOutItems){matching.shift();_this.layout.layoutElement(item.widget);laidOutItems++;if(typeof _this.onLayoutChange==="function"){_this.onLayoutChange()}item=matching[0]}return showSyncWidgets()}};bump=function(showall){if(showall==null){showall=false}if(showall){laidOutItems=1e5}else{laidOutItems++}showSyncWidgets();if(syncWidgets.length){return setTimeout(bump,hasAsyncWidgets?500:0)}};_ref2=this.widgetContents;for(_k=0,_len1=_ref2.length;_k<_len1;_k++){widgetContent=_ref2[_k];this.itemTemplate(widgetContent,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad)}setTimeout(bump,hasAsyncWidgets?500:0);return setTimeout(function(){return bump(true)},7e3)};return LayoutHelper}();window.Poe3.LayoutHelper=LayoutHelper}).call(this);(function(){var BaseView,ModalView,PageView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};BaseView=function(_super){__extends(BaseView,_super);function BaseView(options){if(options==null){options={}}this.countWords=__bind(this.countWords,this);this.countLines=__bind(this.countLines,this);this.sanitize=__bind(this.sanitize,this);this.replaceWithHumor=__bind(this.replaceWithHumor,this);this.onRenderComplete=__bind(this.onRenderComplete,this);this.defaultLayoutStyle=__bind(this.defaultLayoutStyle,this);this.getImageDimensions=__bind(this.getImageDimensions,this);this.instanceid=Poe3.uniqueId();this.href=window.location.href;BaseView.__super__.constructor.call(this,options)}BaseView.prototype.getImageDimensions=function(url,cb){var img;img=new Image;img.src=url;return img.onload=function(){return cb(null,{width:this.width,height:this.height})}};BaseView.prototype.defaultLayoutStyle=function(){return{top:0,colWidth:300,colSpacing:16,adjustWidth:true,widthToSpacingRatio:6,marginLeft:20,marginRight:32}};BaseView.prototype.onRenderComplete=function(selector){return Poe3.fixAnchors(selector)};BaseView.prototype.replaceWithHumor=function(reason,defaultText){var list;list=function(){switch(reason){case"empty":return["Empty pockets never held anyone back. Only empty heads and empty hearts can do that.","Education's purpose is to replace an empty mind with an open one.","All empty souls tend toward extreme opinions.","I keep my hands empty for the sake of what I have had in them.","Thoughts without content are empty, intuitions without concepts are blind.","Words empty as the wind are best left unsaid.","Prometheus is reaching out for the stars with an empty grin on his face.","I looked into that empty bottle and I saw myself."];case"empty-profile":return['When I die, I want to die like my grandfather who died peacefully in his sleep. Not screaming like all the                      passengers in his car. <span style="font-style: italic">- Will Rogers</span>'];default:return[defaultText]}}();return list[parseInt(Math.random()*list.length)]};BaseView.prototype.sanitize=function(text){text=text.replace(/^\s+|\s+$/g,"");text=text.replace(/[ \t]{2,}/g," ");return text};BaseView.prototype.countLines=function(text){return text.split("\n").length};BaseView.prototype.countWords=function(text){return text.split(" ").length};return BaseView}(Backbone.View);PageView=function(_super){__extends(PageView,_super);function PageView(options){this.setTitle=__bind(this.setTitle,this);app.activeView=this;if($(".modal-popup").length){$(".modal-popup").trigger("close",{navigateBack:false})}app.activeModals=[];PageView.__super__.constructor.apply(this,arguments)}PageView.prototype.setTitle=function(text,addAppname){if(addAppname==null){addAppname=true}return $(document)[0].title=text};return PageView}(BaseView);ModalView=function(_super){__extends(ModalView,_super);function ModalView(options){this._hack_overlayHeightRefresh=__bind(this._hack_overlayHeightRefresh,this);this.closeModalModal=__bind(this.closeModalModal,this);this.displayModalModal=__bind(this.displayModalModal,this);this.hideMessage=__bind(this.hideMessage,this);this.showMessage=__bind(this.showMessage,this);this.closeModal=__bind(this.closeModal,this);this.afterClose=__bind(this.afterClose,this);this.onClose=__bind(this.onClose,this);this.displayModal=__bind(this.displayModal,this);this.createModalContainer=__bind(this.createModalContainer,this);this.setTitle=__bind(this.setTitle,this);this.modalConfig={};ModalView.__super__.constructor.apply(this,arguments)}ModalView.prototype.setTitle=function(text,addAppname){if(addAppname==null){addAppname=true}this.previousDocumentTitle=$(document)[0].title;return $(document)[0].title=text};ModalView.prototype.createModalContainer=function(className){var me,previous,_this=this;this.className=className;if(!this.modalInitialized){$("body").append('<div class="'+this.className+' modal-popup"></div>');app.activeModals.push(this);if(app.activeModals.length>1){me=app.activeModals[app.activeModals.length-1];previous=app.activeModals[app.activeModals.length-2];if(this===me){$("."+previous.className).css("opacity","0.2");return $(document).bindNew("click","."+previous.className,function(){return $("."+_this.className).trigger("close")})}}}else{return $("."+this.className).html("")}};ModalView.prototype.displayModal=function(){var _this=this;if(!this.modalInitialized){this.modalInitialized=true;this.lightbox={};$("."+this.className).lightbox_me({onClose:this.onClose,overlayCSS:{background:"black",opacity:.98},destroyOnClose:true,lightboxReference:this.lightbox});$("."+this.className).prepend('                <p class="close-modal">                    <i class="icon-remove"></i>                </p>');$(document).bindNew("mouseenter","."+this.className,function(){_this.fadePopup=false;return $("."+_this.className+" .close-modal").addClass("visible")});$(document).bindNew("mouseleave","."+this.className,function(){_this.fadePopup=true;return setTimeout(function(){if(_this.fadePopup){return $("."+_this.className+" .close-modal").removeClass("visible")}},2e3)});return $(document).bindNew("click","."+this.className+" > .close-modal",function(){return $("."+_this.className).trigger("close",{mustClose:true})})}};ModalView.prototype.onClose=function(e,options){var last,modalModal,_ref,_ref1;if(options==null){options={}}if((_ref=options.navigateBack)==null){options.navigateBack=true}if((_ref1=options.mustClose)==null){options.mustClose=false}modalModal=$("."+this.className+" .modal-modal");if(modalModal.length&&!options.mustClose){this.closeModalModal();return{close:false}}else{if(this.previousDocumentTitle){$(document)[0].title=this.previousDocumentTitle}app.activeModals.pop();if(app.activeModals.length){last=app.activeModals[app.activeModals.length-1];$("."+last.className).css("opacity","1.0");$(document).off("click","."+last.className)}this.closeModalModal();return{close:true,afterClose:this.afterClose(options)}}};ModalView.prototype.afterClose=function(options){var _this=this;return function(){if(options.navigateBack){if(_this.modalConfig.returnUrl){return app.navigate(_this.modalConfig.returnUrl,true)}else{if(app.activeView){if(!_this.modalConfig.urlLess){app.activeView.modalClosed=true;return history.back()}}else{if(!app.activeModals.length){return app.navigate("/",true)}}}}}};ModalView.prototype.closeModal=function(){return $("."+this.className).trigger("close",{mustClose:true})};ModalView.prototype.showMessage=function(text,type){$("."+this.className+" div.message").html(text);if(type){$("."+this.className+" div.message").addClass(type)}return $("."+this.className+" div.message").show()};ModalView.prototype.hideMessage=function(){return $("."+this.className+" div.message").hide()};ModalView.prototype.displayModalModal=function(parentSection,content,height){var modalModal,top,_this=this;$("."+this.className+" .modal-modal").remove();parentSection.append('<div class="modal-modal" style="display:none"></div>');modalModal=$("."+this.className+" .modal-modal");modalModal.append(content);height=height!=null?height:modalModal.height()+32;top=parentSection.height()-(height+48);if(top<64){top=64}modalModal.css("min-height",""+height+"px");modalModal.css("top",""+top+"px");modalModal.css("padding","24px");modalModal.css("width",""+(parentSection.width()-48)+"px");$("."+this.className+" .modal-modal").prepend('            <p class="close-modal">                <i class="icon-remove"></i>            </p>');$(document).bindNew("click","."+this.className+" .modal-modal > .close-modal",function(){return _this.closeModalModal()});$(document).bindNew("click","."+this.className,function(){if($("."+_this.className+" .modal-modal").length){return _this.closeModalModal()}});$(document).bindNew("click","."+this.className+" .modal-modal",function(){return false});return modalModal.show()};ModalView.prototype.closeModalModal=function(){$(document).off("click","."+this.className);$("."+this.className+" .modal-modal").remove();return false};ModalView.prototype._hack_overlayHeightRefresh=function(){return this.lightbox.setOverlayHeight()};return ModalView}(BaseView);window.Poe3.BaseView=BaseView;window.Poe3.PageView=PageView;window.Poe3.ModalView=ModalView}).call(this);(function(){var NewPostView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};NewPostView=function(_super){__extends(NewPostView,_super);function NewPostView(){this.createPost=__bind(this.createPost,this);this.hideContentError=__bind(this.hideContentError,this);this.showContentError=__bind(this.showContentError,this);this.validateContent=__bind(this.validateContent,this);this.setCreatePostHeading=__bind(this.setCreatePostHeading,this);this.otherMode=__bind(this.otherMode,this);this.updateForm=__bind(this.updateForm,this);this.getAttachmentType=__bind(this.getAttachmentType,this);this.getPostType=__bind(this.getPostType,this);this.getAuthoringMode=__bind(this.getAuthoringMode,this);this.onFileSelect=__bind(this.onFileSelect,this);this.applyImageFilter=__bind(this.applyImageFilter,this);this.setPicture=__bind(this.setPicture,this);this.onImageUrlChange=__bind(this.onImageUrlChange,this);this.onResetPicture=__bind(this.onResetPicture,this);this.attachEvents=__bind(this.attachEvents,this);this.render=__bind(this.render,this);this.initialize=__bind(this.initialize,this);return NewPostView.__super__.constructor.apply(this,arguments)}NewPostView.prototype.initialize=function(){$("#content").html(this.el);return this.render()};NewPostView.prototype.render=function(){this.setTitle("Create a New Poem");$(this.el).html(this.template({}));this.attachEvents();this.updateForm();return this.onRenderComplete(".new-post-view")};NewPostView.prototype.attachEvents=function(){var self,_fn,_i,_len,_ref,_t,_this=this;self=this;$(document).bindNew("click",".authoring-mode li",function(){if(!$(this).hasClass("disabled")){$(".authoring-mode li").removeClass("selected");$(this).addClass("selected");self.updateForm()}return false});$(document).bindNew("click",".post-type li",function(){if(!$(this).hasClass("disabled")){$(".post-type li").removeClass("selected");$(this).addClass("selected");self.updateForm()}return false});self.speechBubble={};_ref=["haiku","six-word-story","quote","free-verse"];_fn=function(_t){$(document).bindNew("mouseenter",'.post-type li[data-value="'+_t+'"]',function(){self.speechBubble[_t]=function(){$(".speech-bubble").hide();return $(".speech-bubble."+_t).show()};return setTimeout(function(){var _base;return typeof(_base=self.speechBubble)[_t]==="function"?_base[_t]():void 0},1e3)});return $(document).bindNew("mouseleave",'.post-type li[data-value="'+_t+'"]',function(){self.speechBubble[_t]=null;return setTimeout(function(){if(!(self.speechBubble[_t]!=null)){return $(".speech-bubble."+_t).hide()}},2e3)})};for(_i=0,_len=_ref.length;_i<_len;_i++){_t=_ref[_i];_fn(_t)}$(document).bindNew("click",".credits-link",function(){if($(".picture-credits").hasClass("hidden")){$(".picture-credits").removeClass("hidden");return $(".credits-link").html("Remove image credits")}else{$(".picture-credits").addClass("hidden");$(".image-credits-name").val("");$(".image-credits-website").val("");return $(".credits-link").html("Add image credits")}});$(document).bindNew("click",".attachment-type li",function(){if(!$(this).hasClass("disabled")){$(".attachment-type li").removeClass("selected");$(this).addClass("selected");self.updateForm()}return false});$(document).bindNew("change",".file-input",this.onFileSelect);$(document).bindNew("paste",".image-url",function(){return _this.onImageUrlChange()});$(document).bindNew("blur",".image-url",function(){return _this.onImageUrlChange()});$(document).bindNew("click",".show-upload-box",function(){$(".image-url").val("");$(".with-url").hide();$(".with-upload").show();return false});$(document).bindNew("click",".show-image-url",function(){$(".image-url").val("");$(".with-upload").hide();$(".with-url").show();return false});$(document).bindNew("click","a.change-picture",this.onResetPicture);$(document).bindNew("click","a.image-effect",function(){return self.applyImageFilter(this)});return $(document).bindNew("click","button.create",function(){return _this.createPost()})};NewPostView.prototype.onResetPicture=function(){$(".create-post-section .background").hide();$(".new-post-view .image-url").val("");$(".new-post-view .file-input").replaceWith('<input type="file" class="file-input" name="file" />');$(".new-post-view .file-input").bindNew("change",this.onFileSelect);$(".new-post-view .upload-box").show();return false};NewPostView.prototype.onImageUrlChange=function(){var ext,msg,url,_this=this;$(".picture-section .message").hide();url=$(".image-url").val().trim();if(url!==""){ext=url.split("/").pop().split(".").pop().toLowerCase();if(ext==="png"||ext==="jpg"||ext==="jpeg"||ext==="gif"||ext==="bmp"){$(".upload-box").hide();$(".create-post-section .background .picture-options").hide();$(".create-post-section .background").show();$(".create-post-section .background .pic-container").html('                    <img src="/images/loading.gif" class="loading" alt="loading" />                     <span class="text">Loading...</span>                     <a class="text cancel" href="#">cancel</a>');$(document).bindNew("click",".create-post-section .background .cancel",function(){$(".create-post-section .background .pic-container").html("");return _this.onResetPicture()});return $.ajax({url:Poe3.apiUrl("files/processurl"),data:{url:url},type:"GET",success:function(resp){if($(".create-post-section .background img.loading").length){return _this.setPicture(resp.attachment,resp.attachmentThumbnail)}}})}else{msg="Url should end with .jpg, .jpeg or .png. Alternatively, you could upload it.";$(".picture-section .message").html('<i class="icon-remove-sign"></i>'+msg);return $(".picture-section .message").show()}}};NewPostView.prototype.setPicture=function(url,thumbnailUrl,options){if(options==null){options={clearFilterSelection:true}}$(".create-post-section .background").show();$(".create-post-section .background .picture-options").show();$(".create-post-section .background .pic-container").html('<img src="'+url+'" data-filter="none" data-src="'+url+'" data-thumbnail-src="'+thumbnailUrl+'" class="picture" />');if(options.clearFilterSelection){$("a.image-effect").removeClass("selected");return $("a.image-effect").first().addClass("selected")}};NewPostView.prototype.applyImageFilter=function(elem){var attachment,attachmentThumbnail,currentFilter,filter,fnApply,pic,_this=this;elem=$(elem);$("a.image-effect").removeClass("selected");elem.addClass("selected");attachment=$(".new-post-view .picture-section .background img.picture").data("src");attachmentThumbnail=$(".new-post-view .picture-section .background img.picture").data("thumbnail-src");pic=$(".new-post-view .picture-section .background img.picture");fnApply=function(){pic.data("filter",filter);$(".new-post-view .picture-section .background .effects .text").html(filter==="none"?"faithful":filter);switch(filter){case"none":return _this.setPicture(attachment,attachmentThumbnail);case"vintage":return pic.vintage({preset:"default"});case"grayscale":return pic.vintage({preset:"grayscale"});case"sepia":return pic.vintage({preset:"sepia"})}};filter=elem.data("filter");currentFilter=pic.data("filter");if(filter!=="none"&&currentFilter!=="none"){this.setPicture(attachment,attachmentThumbnail,{clearFilterSelection:false});pic=$(".new-post-view .picture-section .background img.picture");setTimeout(fnApply,200)}else{fnApply()}return false};NewPostView.prototype.onFileSelect=function(){var form,frame,_this=this;form=$(".upload-form");form.attr("action",Poe3.apiUrl("files",{passkey:app.passkey}));frame=$("#upload-frame");frame.bindNew("load",function(){var attachment,attachmentThumbnail;attachment=JSON.parse($(frame[0].contentWindow.document).text()).attachment;attachmentThumbnail=JSON.parse($(frame[0].contentWindow.document).text()).attachmentThumbnail;$(".upload-box").hide();return _this.setPicture(attachment,attachmentThumbnail)});return form.submit()};NewPostView.prototype.getAuthoringMode=function(){return $(".authoring-mode li.selected").data("value")};NewPostView.prototype.getPostType=function(){return $(".post-type li.selected").data("value")};NewPostView.prototype.getAttachmentType=function(){return $(".attachment-type li.selected").data("value")};NewPostView.prototype.updateForm=function(){var attachmentType,mode,postType,_ref;mode=this.getAuthoringMode();postType=this.getPostType();attachmentType=this.getAttachmentType();if(mode==="collaborative"&&postType==="quote"){$(".post-type li").removeClass("selected");$('.post-type li[data-value="haiku"]').addClass("selected");return this.updateForm()}$('.radio li[data-value="quote"]')[mode==="collaborative"?"addClass":"removeClass"]("disabled");if(attachmentType==="image"){$(".picture-section").show()}else{$(".picture-section").hide()}this.setCreatePostHeading();$(".post-type-form").hide();$("."+postType+"-form ."+mode).show();$("."+postType+"-form ."+this.otherMode(mode)).hide();$("."+postType+"-form").show();if((_ref=this.currentContent)!=null?_ref.val():void 0){$("."+postType+"-form ."+mode+" .content").val(this.currentContent.val())}this.currentContent=$("."+postType+"-form ."+mode+" .content");return $("button.create").html('<i class="icon-ok"></i>'+(mode==="solo"?"Publish":"Create"))};NewPostView.prototype.otherMode=function(mode){if(mode==="solo"){return"collaborative"}else{return"solo"}};NewPostView.prototype.setCreatePostHeading=function(){var attachmentType,hasPic,postType;attachmentType=this.getAttachmentType();postType=this.getPostType();hasPic=attachmentType==="image";return $(".create-post-section h2").html(function(){switch(postType){case"haiku":if(hasPic){return"Upload a Picture and Write some Haiku"}else{return"Write some Haiku"}break;case"free-verse":if(hasPic){return"Upload a Picture and Write Free-Style Poetry"}else{return"Write Free-Style Poetry"}break;case"six-word-story":if(hasPic){return"Upload a Picture and Write a Six-Word Story"}else{return"Write a Six-Word Story"}break;case"quote":if(hasPic){return"Upload a Picture and Write a Quote"}else{return"Write a Quote"}}}())};NewPostView.prototype.validateContent=function(text){var mode,postType;mode=this.getAuthoringMode();postType=this.getPostType();text=this.sanitize(text);if(!text){this.showContentError("You haven't written anything.");return false}if(mode==="collaborative"){if(postType==="haiku"&&this.countLines(text)>=3){this.showContentError("In a collaborative Haiku, you cannot write more than two lines.");return false}else if(postType==="six-word-story"&&this.countWords(text)>=6){this.showContentError("In a collaborative Six Word Story, you cannot write more than five words.");return false}}else{if(postType==="haiku"&&this.countLines(text)!==3){this.showContentError("There should be three lines in a Haiku.");return false}else if(postType==="six-word-story"&&this.countWords(text)!==6){this.showContentError("There should be six words in a Six Word Story.");return false}}this.hideContentError();return true};NewPostView.prototype.showContentError=function(error){$(".content-error").html('<i class="icon-remove-sign"></i> '+error);return $(".content-error").show()};NewPostView.prototype.hideContentError=function(){return $(".content-error").hide()};NewPostView.prototype.createPost=function(){var content,imageSrc,imgElem,params,post,postType,_this=this;if(!this.saving){postType=this.getPostType();content=this.currentContent.val();if(this.validateContent(content)){params={type:postType,tags:$("input.tags").val(),attachmentType:this.getAttachmentType(),content:content,authoringMode:this.getAuthoringMode()};if(postType==="free-verse"&&$(".free-verse-form .title").val()){params.title=$(".free-verse-form .title").val()}imgElem=$(".create-post-section .background img.picture");imageSrc=imgElem.attr("src");if(params.attachmentType&&imageSrc){params.attachment=imageSrc;params.attachmentSourceFormat=imgElem.data("filter")==="none"?"url":"binary";params.attachmentThumbnail=imgElem.data("filter")==="none"?imgElem.data("thumbnail-src"):void 0;
if($(".image-credits-name").val()){params.attachmentCreditsName=$(".image-credits-name").val();if($(".image-credits-website").val()){params.attachmentCreditsWebsite=$(".image-credits-website").val()}}}else{params.attachmentType=""}this.saving=true;post=new Poe3.Post(params);return post.save({},{success:function(model,resp){new Poe3.PostView(resp.uid,{returnUrl:"/"+app.getUser().domain+"/"+app.getUser().username});return app.navigate("/"+resp.uid,false)}})}}};return NewPostView}(Poe3.PageView);window.Poe3.NewPostView=NewPostView}).call(this);(function(){var PostListView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};PostListView=function(_super){__extends(PostListView,_super);function PostListView(renderTo,tagPrefix,posts){this.renderTo=renderTo;this.tagPrefix=tagPrefix;this.posts=posts;this.updatePost=__bind(this.updatePost,this);this.getPostByUID=__bind(this.getPostByUID,this);this.render=__bind(this.render,this);this.initialize=__bind(this.initialize,this);PostListView.__super__.constructor.call(this,{model:this.model})}PostListView.prototype.initialize=function(){this.containerPrefix="e_"+Poe3.uniqueId();return $(this.renderTo).html(this.el)};PostListView.prototype.render=function(){var attachContribAlert,layoutHelper,style,_this=this;$(this.el).html(this.template({}));style=this.defaultLayoutStyle();style.marginLeft=0;attachContribAlert=function(_post,fn){return function(html){var currentParts,numContribs,part;fn(html);currentParts=function(){var _i,_len,_ref,_results;_ref=_post.get("parts");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];if(part.sequence===_post.get("selectedParts").length){_results.push(part)}}return _results}();numContribs=currentParts.length;if(numContribs>0){return $(""+_this.containerPrefix+"-#postid-"+_post.id).prepend('                        <div class="contrib-alert">                            <span class="icon">                                <i class="icon-file"></i> '+numContribs+'                             </span>                            <span class="subtext">                                from '+function(){var _i,_len,_results;_results=[];for(_i=0,_len=currentParts.length;_i<_len;_i++){part=currentParts[_i];_results.push(part.createdBy.name)}return _results}().join(", ")+'                            </span>                            <div style="clear:both"></div>                        </div>')}}};layoutHelper=new Poe3.LayoutHelper(this.posts,style,".post-list-view .viewport",".post-list-view .items",function(post){return"#"+_this.containerPrefix+"-postid-"+post.id},function(post){return post.isLoadedAsync()},function(post,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad){return new Poe3.PostListViewItem(post,_this.containerPrefix,_this.tagPrefix,attachContribAlert(post,fnAppend),fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad)},function(){});return layoutHelper.doLayout()};PostListView.prototype.getPostByUID=function(uid){var post;return function(){var _i,_len,_ref,_results;_ref=this.posts;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){post=_ref[_i];if(post.get("uid")===uid){_results.push(post)}}return _results}.call(this)[0]};PostListView.prototype.updatePost=function(post){var p;this.posts=function(){var _i,_len,_ref,_results;_ref=this.posts;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];if(p.get("uid")!==post.get("uid")){_results.push(p)}}return _results}.call(this);return this.posts.push(post)};return PostListView}(Poe3.BaseView);window.Poe3.PostListView=PostListView}).call(this);(function(){var PostListViewItem,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};PostListViewItem=function(_super){__extends(PostListViewItem,_super);function PostListViewItem(model,containerPrefix,tagPrefix,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad){this.model=model;this.containerPrefix=containerPrefix;this.tagPrefix=tagPrefix;this.fnAppend=fnAppend;this.fnOnAsyncWidgetLoad=fnOnAsyncWidgetLoad;this.fnOnSyncWidgetLoad=fnOnSyncWidgetLoad;this.render=__bind(this.render,this);PostListViewItem.__super__.constructor.call(this);this.render()}PostListViewItem.prototype.render=function(){var author,authors,html,k,params,part,v,_fn,_i,_j,_len,_len1,_ref,_ref1,_this=this;authors={};_ref=this.model.get("selectedParts");for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];authors[part.createdBy.id]=part.createdBy}this.model.set("cols",1);params={post:this.model.toTemplateParam(),containerPrefix:this.containerPrefix,tagPrefix:this.tagPrefix};params.authors=function(){var _results;_results=[];for(k in authors){v=authors[k];_results.push(v)}return _results}();params.formattedParts=this.model.format("condensed");if(this.model.get("attachmentType")==="image"){params.displayClass="with-image";params.attachmentIsImage=true}else{params.displayClass="just-text"}html=this.template(params);this.fnAppend(html);$(document).bindNew("click","#"+this.containerPrefix+"-postid-"+this.model.id,function(){var uid;uid=_this.model.get("uid");new Poe3.PostView(uid,{tagPrefix:_this.tagPrefix});app.navigate("/"+uid,{trigger:false});return false});_ref1=params.authors;_fn=function(author){return $(document).bindNew("click","#"+_this.containerPrefix+"-postid-"+_this.model.id+"-author-"+author.id,function(){app.navigate("/"+author.domain+"/"+author.username,{trigger:true});return false})};for(_j=0,_len1=_ref1.length;_j<_len1;_j++){author=_ref1[_j];_fn(author)}if(this.model.get("attachmentType")==="image"){$("#"+this.containerPrefix+"-postid-"+this.model.id+" .background").imagesLoaded(function(){return _this.fnOnAsyncWidgetLoad(_this.model)})}else{this.fnOnSyncWidgetLoad(this.model)}return this.onRenderComplete("#"+this.containerPrefix+"-postid-"+this.model.id)};return PostListViewItem}(Poe3.BaseView);window.Poe3.PostListViewItem=PostListViewItem}).call(this);(function(){var PostsView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};PostsView=function(_super){__extends(PostsView,_super);function PostsView(params){var _base,_ref;this.params=params!=null?params:{};this.updatePost=__bind(this.updatePost,this);this.getPostByUID=__bind(this.getPostByUID,this);this.resizeOnRefresh=__bind(this.resizeOnRefresh,this);this.applyFilter=__bind(this.applyFilter,this);this.attachEvents=__bind(this.attachEvents,this);this.fetch=__bind(this.fetch,this);this.onNextPage=__bind(this.onNextPage,this);this.onPreviousPage=__bind(this.onPreviousPage,this);this.switchPage=__bind(this.switchPage,this);this.setupPaging=__bind(this.setupPaging,this);this.loadCategory=__bind(this.loadCategory,this);this.render=__bind(this.render,this);this.initialize=__bind(this.initialize,this);if((_ref=(_base=this.params).category)==null){_base.category="all"}if(["haiku","six-word-story","quote","free-verse"].indexOf(this.params.category)>-1){this.params.type=this.params.category;this.params.category="all"}if(this.params.category==="text"){this.params.attachmentType="";this.params.category="all"}if(["all","open","popular"].indexOf(this.params.category)>-1){if(this.params.subCategory){if(["haiku","six-word-story","quote","free-verse"].indexOf(this.params.subCategory)>-1){this.params.type=this.params.subCategory}if(this.params.subCategory==="text"){this.params.attachmentType=""}}}this.tagPrefix=this.params.category==="open"?"/posts/open":"/posts";this.pageNumber=1;this.pageSize=50;PostsView.__super__.constructor.call(this,{model:new Poe3.Posts})}PostsView.prototype.initialize=function(){$("#content").html(this.el);$(this.el).html(this.template({}));if(this.params.type){$(".posts-view .filter .active .prefix").html('<span class="anchor cancel-filter"><i class="icon-circle-arrow-left"></i></span>');$(".posts-view .filter .active i.icon-filter").hide();$(".posts-view .filter .active a.type").html(this.params.type)}else if(this.params.attachmentType!=null){$(".posts-view .filter .active .prefix").html('<span class="anchor cancel-filter"><i class="icon-circle-arrow-left"></i></span>');$(".posts-view .filter .active i.icon-filter").hide();$(".posts-view .filter .active a.type").html("text")}this.attachEvents();this.onRenderComplete("#content");return this.loadCategory()};PostsView.prototype.render=function(posts){switch(this.params.category){case"all":this.setTitle("All poems");break;case"open":this.setTitle("Open poems");break;case"popular":this.setTitle("Popular poems")}posts=posts.toArray();this.postListView=new Poe3.PostListView("#content .page-content",this.tagPrefix,posts);return this.postListView.render()};PostsView.prototype.loadCategory=function(){var _this=this;$(".posts-view .std-menu ul span.tag").remove();$(".posts-view .std-menu li a").removeClass("selected");if(this.params.tag){$(".posts-view .std-menu li span."+this.params.category).append('<span class="tag selected"> #'+this.params.tag+"</span>")}$(".posts-view .std-menu li span."+this.params.category+" a").addClass("selected");return this.fetch({},{},function(posts){if(posts.length>_this.pageSize){_this.setupPaging();return _this.switchPage(posts,1,"forward")}else{return _this.render(posts)}})};PostsView.prototype.setupPaging=function(){var _this=this;$(".posts-view .paginator").html('            <ul>                <li class="prev">                    <i class="icon-chevron-left"></i>                    <a href="#">Prev</a>                </li>                <li class="page-number">                    Page 1                </li>                <li class="next">                    <a href="#">Next</a>                    <i class="icon-chevron-right"></i>                </li>            </ul>');$(document).bindNew("click",".posts-view .paginator .prev, .paginator .prev a",function(){return _this.onPreviousPage()});$(document).bindNew("click",".posts-view .paginator .next, .paginator .next a",function(){return _this.onNextPage()});$(".posts-view .paginator.top").fadeIn(1e3);return setTimeout(function(){$(".paginator-border-bottom").css("border-top","1px solid #222");return $(".posts-view .paginator.bottom").fadeIn(1e3)},3e3)};PostsView.prototype.switchPage=function(posts,pageNum,fetchDirection){var hasMore,_this=this;this.pageNumber=pageNum;hasMore=posts.length>this.pageSize;if(hasMore){if(fetchDirection==="forward"||pageNum===1){posts.pop()}else{posts.shift()}}if(!hasMore&&fetchDirection==="back"&&this.pageNumber>1){return this.fetch({},{},function(posts){return _this.switchPage(posts,1,"forward")})}else{this.hasNext=fetchDirection==="back"||fetchDirection==="forward"&&hasMore;$(".posts-view .paginator .page-number").html("Page "+this.pageNumber);$(".posts-view .paginator .prev")[this.pageNumber>1?"removeClass":"addClass"]("disabled");$(".posts-view .paginator .next")[this.hasNext?"removeClass":"addClass"]("disabled");return this.render(posts)}};PostsView.prototype.onPreviousPage=function(){var pageNum,params,_this=this;params={};if(this.pageNumber>1){if(this.pageNumber>2){if(this.params.category!=="open"){params.after=this.model.at(0).get("publishedAt")}params.minuid=this.model.at(0).get("uid")}pageNum=this.pageNumber-1;(function(pageNum){return _this.fetch(params,{},function(posts){return _this.switchPage(posts,pageNum,"back")})})(pageNum)}return false};PostsView.prototype.onNextPage=function(){var pageNum,params,_this=this;if(this.hasNext){params={};if(this.params.category!=="open"){params.before=this.model.at(this.model.length-1).get("publishedAt")}params.maxuid=this.model.at(this.model.length-1).get("uid");pageNum=this.pageNumber+1;(function(pageNum){return _this.fetch(params,{},function(posts){return _this.switchPage(posts,pageNum,"forward")})})(pageNum)}return false};PostsView.prototype.fetch=function(data,apiInfo,onLoad){data.limit=this.pageSize+1;data.category=this.params.category;if(this.params.tag){data.tag=this.params.tag}if(this.params.type){data.type=this.params.type}if(this.params.attachmentType!=null){data.attachmentType=this.params.attachmentType}return this.model.fetch({data:data,success:onLoad})};PostsView.prototype.attachEvents=function(){var self,_this=this;self=this;$(document).bindNew("click",".posts-view .filter a.type",function(){$(".posts-view .filter .active").hide();$(".posts-view .filter .select").show();return false});$(document).bindNew("click",".posts-view .filter .select a",function(){var filter;filter=$(this).attr("class");self.applyFilter(filter);return false});return $(document).bindNew("click",".posts-view .filter .cancel-filter",function(){_this.applyFilter("all");return false})};PostsView.prototype.applyFilter=function(filter){if(this.params.category==="all"){if(this.params.tag){if(filter==="all"){return app.navigate("/posts/tagged/"+this.params.tag,true)}else{return app.navigate("/posts/"+filter+"/tagged/"+this.params.tag,true)}}else{if(filter==="all"){return app.navigate("/posts",true)}else{return app.navigate("/posts/"+filter,true)}}}else{if(this.params.tag){if(filter==="all"){return app.navigate("/posts/"+this.params.category+"/tagged/"+this.params.tag,true)}else{return app.navigate("/posts/"+this.params.category+"/"+filter+"/tagged/"+this.params.tag,true)}}else{if(filter==="all"){return app.navigate("/posts/"+this.params.category,true)}else{return app.navigate("/posts/"+this.params.category+"/"+filter,true)}}}};PostsView.prototype.resizeOnRefresh=function(){return true};PostsView.prototype.getPostByUID=function(uid){return this.postListView.getPostByUID(uid)};PostsView.prototype.updatePost=function(post){return this.postListView.updatePost(post)};return PostsView}(Poe3.PageView);window.Poe3.PostsView=PostsView}).call(this);(function(){var TagListView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};TagListView=function(_super){__extends(TagListView,_super);function TagListView(renderTo,posts){this.renderTo=renderTo;this.posts=posts;this.render=__bind(this.render,this);this.initialize=__bind(this.initialize,this);TagListView.__super__.constructor.call(this,{model:this.posts})}TagListView.prototype.initialize=function(){this.containerPrefix="e_"+Poe3.uniqueId();return $(this.renderTo).html(this.el)};TagListView.prototype.render=function(){var coverPosts,getCoverPost,isInCoverPosts,layoutHelper,post,posts,postsList,style,tag,tagDict,_i,_j,_len,_len1,_ref,_ref1,_ref2,_this=this;$(this.el).html(this.template({}));tagDict={};_ref=this.posts;for(_i=0,_len=_ref.length;_i<_len;_i++){post=_ref[_i];if((_ref1=post.get("tags"))!=null?_ref1.length:void 0){_ref2=post.get("tags");for(_j=0,_len1=_ref2.length;_j<_len1;_j++){tag=_ref2[_j];if(!tagDict[tag]){tagDict[tag]=[]}tagDict[tag].push(post)}}}postsList=[];for(tag in tagDict){posts=tagDict[tag];postsList.push({tag:tag,posts:posts,count:posts.length})}coverPosts=[];isInCoverPosts=function(p){var _p;return function(){var _k,_len2,_results;_results=[];for(_k=0,_len2=coverPosts.length;_k<_len2;_k++){_p=coverPosts[_k];if(_p===p){_results.push(_p)}}return _results}().length>0};getCoverPost=function(posts){var cover,notCovered,p,_ref3;notCovered=function(){var _k,_len2,_results;_results=[];for(_k=0,_len2=posts.length;_k<_len2;_k++){p=posts[_k];if(!isInCoverPosts(p)){_results.push(p)}}return _results}();cover=notCovered.length?(_ref3=function(){var _k,_len2,_results;_results=[];for(_k=0,_len2=notCovered.length;_k<_len2;_k++){post=notCovered[_k];if(post.get("attachmentType")==="image"){_results.push(post)}}return _results}()[0])!=null?_ref3:notCovered[0]:posts[0];coverPosts.push(cover);return cover};style=this.defaultLayoutStyle();style.marginLeft=0;style.marginRight=90;style.colWidth=228;layoutHelper=new Poe3.LayoutHelper(postsList,style,".tag-list-view .viewport",".tag-list-view .items",function(item){return"#"+_this.containerPrefix+"-posts-by-tag-"+item.tag},function(item){return item.posts[0].isLoadedAsync()},function(item,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad){return new Poe3.TagListViewItem(item,_this.containerPrefix,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad,getCoverPost)},function(){});return layoutHelper.doLayout()};return TagListView}(Poe3.BaseView);window.Poe3.TagListView=TagListView}).call(this);(function(){var TagListViewItem,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};TagListViewItem=function(_super){__extends(TagListViewItem,_super);function TagListViewItem(model,containerPrefix,fnAppend,fnOnAsyncWidgetLoad,fnOnSyncWidgetLoad,getCoverPost){this.model=model;this.containerPrefix=containerPrefix;this.fnAppend=fnAppend;this.fnOnAsyncWidgetLoad=fnOnAsyncWidgetLoad;this.fnOnSyncWidgetLoad=fnOnSyncWidgetLoad;this.getCoverPost=getCoverPost;this.attachEvents=__bind(this.attachEvents,this);this.render=__bind(this.render,this);TagListViewItem.__super__.constructor.call(this);this.render()}TagListViewItem.prototype.render=function(){var html,_this=this;this.mainPost=this.getCoverPost(this.model.posts);this.model.content=this.mainPost.formatAsIcon();this.model.stacktype=["stacktwo","stackthree","stackfour"][parseInt(Math.random()*3)];this.model.containerPrefix=this.containerPrefix;html=this.template(this.model);this.fnAppend(html);if(this.mainPost.get("attachmentType")==="image"){$("#"+this.containerPrefix+"-posts-by-tag-"+this.model.tag).imagesLoaded(function(){return _this.fnOnAsyncWidgetLoad(_this.model)})}else{this.fnOnSyncWidgetLoad(this.model)}this.attachEvents();return this.onRenderComplete("#"+this.containerPrefix+"-posts-by-tag-"+this.model.tag)};TagListViewItem.prototype.attachEvents=function(){var _this=this;return $(document).bindNew("click","#"+this.containerPrefix+"-posts-by-tag-"+this.model.tag,function(){app.navigate("/"+_this.mainPost.get("createdBy").domain+"/"+_this.mainPost.get("createdBy").username+"/tagged/"+_this.model.tag,false);return new Poe3.PostView({mode:"gallery",data:{posts:_this.model.posts}})})};return TagListViewItem}(Poe3.BaseView);window.Poe3.TagListViewItem=TagListViewItem}).call(this);(function(){var UserListView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};UserListView=function(_super){__extends(UserListView,_super);function UserListView(users,options){this.render=__bind(this.render,this);UserListView.__super__.constructor.call(this,{model:users});this.heading=options.heading;this.render();this.modalConfig.urlLess=true}UserListView.prototype.render=function(){this.createModalContainer("user-list-view-container");$(".user-list-view-container").html(this.el);$(this.el).html(this.template({heading:this.heading,users:this.model}));this.displayModal();return this.onRenderComplete(".user-list-view-container")};return UserListView}(Poe3.ModalView);window.Poe3.UserListView=UserListView}).call(this);(function(){var PostView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};PostView=function(_super){__extends(PostView,_super);function PostView(params,options){this.getModalSize=__bind(this.getModalSize,this);this.setupModal=__bind(this.setupModal,this);this.deleteParentPost=__bind(this.deleteParentPost,this);this.updateParentPost=__bind(this.updateParentPost,this);this.hideContentError=__bind(this.hideContentError,this);this.showContentError=__bind(this.showContentError,this);this.onSettingsClick=__bind(this.onSettingsClick,this);this.onLikeClick=__bind(this.onLikeClick,this);this.onSelectPartClick=__bind(this.onSelectPartClick,this);this.onRemovePartClick=__bind(this.onRemovePartClick,this);this.onSubmitPartClick=__bind(this.onSubmitPartClick,this);this.onPublishClick=__bind(this.onPublishClick,this);this.onSaveComment=__bind(this.onSaveComment,this);this.onPin=__bind(this.onPin,this);this.onTweet=__bind(this.onTweet,this);this.onFacebookShare=__bind(this.onFacebookShare,this);this.attachEvents=__bind(this.attachEvents,this);this.galleryNext=__bind(this.galleryNext,this);this.galleryPrevious=__bind(this.galleryPrevious,this);this.addGalleryNavigation=__bind(this.addGalleryNavigation,this);this.addSettingsButton=__bind(this.addSettingsButton,this);this.addLikeButton=__bind(this.addLikeButton,this);this.addCompletionMessage=__bind(this.addCompletionMessage,this);this.displayComments=__bind(this.displayComments,this);this.addComments=__bind(this.addComments,this);this.render=__bind(this.render,this);var post,_ref,_ref1;this.tagPrefix=(_ref=options!=null?options.tagPrefix:void 0)!=null?_ref:"/posts";if(typeof params==="string"||typeof params==="number"){this.uid=params;if(((_ref1=app.activeView)!=null?_ref1.getPostByUID:void 0)!=null&&(post=app.activeView.getPostByUID(parseInt(this.uid)))){PostView.__super__.constructor.call(this,{model:post});this.model.bind("change",this.render,this);this.render()}else{PostView.__super__.constructor.call(this,{model:new Poe3.Post({uid:this.uid})});this.model.bind("change",this.render,this);this.model.fetch()}}else{this.gallery=params.data;post=this.gallery.posts[0];PostView.__super__.constructor.call(this,{model:post});this.model.bind("change",this.render,this);this.render()}if(options!=null?options.returnUrl:void 0){this.modalConfig.returnUrl=options.returnUrl}}PostView.prototype.render=function(){var authors,k,onModalReady,params,part,post,postedAt,v,_i,_len,_ref,_ref1,_this=this;this.setTitle(this.model.getPostName(50));post=this.model.toTemplateParam();this.createModalContainer("post-view-container");authors={};_ref=post.selectedParts;for(_i=0,_len=_ref.length;_i<_len;_i++){part=_ref[_i];authors[part.createdBy.id]=part.createdBy}params={};params.post=post;params.authors=function(){var _results;_results=[];for(k in authors){v=authors[k];_results.push(v)}return _results}();params.formattedParts=this.model.format();params.partEditor=this.model.getPartEditor();postedAt=(_ref1=this.model.get("publishedAt"))!=null?_ref1:this.model.get("timestamp");params.postedAt=moment(new Date(postedAt)).fromNow();params.notes=this.model.formatNotes();params.hasLikes=this.model.get("likes").length>0;params.tagPrefix=this.tagPrefix;params.isComplete=post.state==="complete";if(this.model.get("attachmentType")==="image"){params.displayClass="with-image";params.attachmentIsImage=true;if(this.model.get("attachmentCreditsName")){if(this.model.get("attachmentCreditsWebsite")){params.attachmentCredits='<p class="attachment-credits"><i class="icon-picture"></i> <a href="'+this.model.get("attachmentCreditsWebsite")+'">'+this.model.get("attachmentCreditsName")+"</a></p>"}else{params.attachmentCredits='<p class="attachment-credits"><i class="icon-picture"></i> '+this.model.get("attachmentCreditsName")+"</p>"}}}else{params.displayClass="just-text"}if(this.gallery){params.isGallery=true}$(this.el).html(this.template(params));$(".post-view-container").html(this.el);$(".social-share .social-action").html(this.model.get("state")==="complete"?"Share on":"Invite contributors");if(this.model.get("attachmentType")==="image"){$(".social-share .pinterest").show()}else{$(".social-share .pinterest").hide()}this.addComments();this.addCompletionMessage();this.addLikeButton();this.addSettingsButton();if(this.gallery){this.addGalleryNavigation()}this.attachEvents();onModalReady=function(){var fontSize,lineHeight,modalSize;modalSize=_this.getModalSize();fontSize=_this.model.getFontSize(modalSize);$(".post-view-container .parts").css("font-size",""+fontSize+"px");lineHeight=fontSize<=18?"1.3":"1.2";$(".post-view-container .parts").css("line-height",""+lineHeight);_this.setupModal(modalSize);$(".post-view .notes, .post-view .post-details").show();$(".post-view .notes, .post-view .social-share").show();return $(".post-view .notes, .post-view .comments-container").show()};if(this.model.get("attachmentType")==="image"){$(".post-view .post-box .background").imagesLoaded(onModalReady)}else{onModalReady()}return this.onRenderComplete(".post-view-container")};PostView.prototype.addComments=function(){var comments;comments=new Poe3.Comments;comments.bind("reset",this.displayComments,this);comments.postid=this.model.id;return comments.fetch()};PostView.prototype.displayComments=function(commentsModel){return $(".post-view .comments-container").html(this.commentsTemplate({comments:commentsModel.toJSON()}))};PostView.prototype.addCompletionMessage=function(){var completionMessage;completionMessage=this.model.getCompletionMessage();if(completionMessage){return this.showMessage(completionMessage.text,completionMessage.type)}};PostView.prototype.addLikeButton=function(){var like,likeButton,yourLikes;likeButton=$(".post-view .post-buttons i.like-button");likeButton.removeClass("icon-heart");likeButton.removeClass("icon-heart-empty");yourLikes=function(){var _i,_len,_ref,_results;_ref=this.model.get("likes");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){like=_ref[_i];if(like.id===app.getUser().id){_results.push(like)}}return _results}.call(this);if(yourLikes.length){return likeButton.addClass("icon-heart")}else{return likeButton.addClass("icon-heart-empty")}};PostView.prototype.addSettingsButton=function(){if(this.model.get("createdBy").id===app.getUser().id){return $(".post-view .post-buttons .settings-button").show()}};PostView.prototype.addGalleryNavigation=function(){var i,li,list,post,self,_results;self=this;if(!this.galleryCursor){this.galleryCursor=0}$(document).bindNew("click",".gallery-nav .left-cursor",this.galleryPrevious);$(document).bindNew("click",".gallery-nav .right-cursor",this.galleryNext);$(document).bind("keyup","left",this.galleryPrevious);$(document).bind("keyup","right",this.galleryNext);$(".post-view .gallery").html('            <div class="container">                <ul></ul>            </div>            <div class="overlay"></div>');list=$(".post-view .gallery").find("ul");i=0;_results=[];while(i<this.gallery.posts.length){post=this.gallery.posts[i];li=$("<li></li>");li.html(post.formatAsIcon());li.data("post",post);li.data("cursor",i);li.appendTo(list);li.click(function(){self.model=$(this).data("post");self.galleryCursor=$(this).data("cursor");return self.render()});if(this.galleryCursor===i){li.addClass("selected")}_results.push(i++)}return _results};PostView.prototype.galleryPrevious=function(){var _this=this;if(this.cancelKeyPress){return}this.cancelKeyPress=true;return setTimeout(function(){_this.cancelKeyPress=false;if(_this.galleryCursor>0){_this.galleryCursor--;_this.model=_this.gallery.posts[_this.galleryCursor];return _this.render()}},100)};PostView.prototype.galleryNext=function(){var _this=this;if(this.cancelKeyPress){return}this.cancelKeyPress=true;return setTimeout(function(){_this.cancelKeyPress=false;if(_this.galleryCursor<_this.gallery.posts.length-1){_this.galleryCursor++;_this.model=_this.gallery.posts[_this.galleryCursor];return _this.render()}},100)};PostView.prototype.attachEvents=function(){var _this=this;$(document).bindNew("click",".post-view .part-select-item",this.onSelectPartClick());$(document).bindNew("click",".post-view .parts .remove-part",this.onRemovePartClick());$(document).bindNew("click",".post-view button.publish",this.onPublishClick);$(document).bindNew("click",".post-view button.submit",this.onSubmitPartClick);$(document).bindNew("click",".post-view .post-buttons i.like-button",this.onLikeClick);$(document).bindNew("click",".post-view .post-buttons i.settings-button",this.onSettingsClick);$(document).bindNew("mouseenter",".post-view .parts .last span.remove-part",function(){return $(this).parent().addClass("selected")});$(document).bindNew("mouseleave",".post-view .parts .last span.remove-part",function(){return $(this).parent().removeClass("selected")});$(document).bindNew("click",".post-view .authors li",function(){return app.navigate("/"+$(this).data("domain")+"/"+$(this).data("username"),true)});$(document).bindNew("click",".post-view .write-part-link",function(){$(".part-select-container").hide();$(".add-part").show();return false});$(document).bindNew("click",".post-view .select-contrib-link",function(){$(".add-part").hide();$(".part-select-container").show();return false});$(document).bindNew("click",".post-view .comments a.new-comment",function(){var loginView;if(app.isAuthenticated()){$(".post-view .comments .comment-form").show();$(".post-view .comments .comment-form textarea").focus();$(".post-view .comments .add-comment-link").hide();_this._hack_overlayHeightRefresh()}else{loginView=new Poe3.LoginView}return false});$(document).bindNew("click",".post-view .comments button.save",this.onSaveComment);$(document).bindNew("click",".post-view .social-share .facebook img, .post-view .social-share .facebook a",this.onFacebookShare);$(document).bindNew("click",".post-view .social-share .twitter img, .post-view .social-share .twitter a",this.onTweet);return $(document).bindNew("click",".post-view .social-share .pinterest img, .post-view .social-share .pinterest a",this.onPin)};PostView.prototype.onFacebookShare=function(){var collaborative,message,params,picture,postName,postUrl,url,_ref,_this=this;if(this.model.get("state")==="complete"){collaborative=this.model.get("authoringMode")==="collaborative"?"collaborative ":"";postUrl=app.pathToUrl(this.model.get("uid"));if(app.isAuthenticated()&&app.getUser().domain==="fb"){message=""+postUrl+"\n\n"+this.model.summarizeContent("full");picture=this.model.get("attachment")?app.pathToUrl(this.model.get("attachment")):void 0;new Poe3.FacebookSharePostView(message,picture,this.model.id,function(){return $(".post-view .social-share .facebook").html('<i class="icon-ok"><i> Shared on Facebook.')});return false}else{params={method:"feed",name:this.model.getPostName(),picture:(_ref=app.pathToUrl(this.model.get("attachment")))!=null?_ref:this.model.get("createdBy").picture,link:app.pathToUrl(this.model.get("uid")),description:this.model.summarizeContent("short")};FB.ui(params,function(resp){var published;published=resp&&resp.post_id;if(published){return $(".post-view .social-share .facebook").html('<i class="icon-ok"></i> Shared on Facebook.')}});return false}}else{postName=this.model.getPostName(100).substring(0,50);if(!/\.$/.test(postName)){postName+="..."}url=window.location.hostname+("/"+this.model.get("uid"));FB.ui({method:"apprequests",display:"popup",message:"Complete the "+this.model.formatType()+" ("+postName+") at "+url,data:"redirect_to_post:"+this.model.get("uid")},function(resp){if(resp){return $.ajax({url:Poe3.apiUrl("tokens"),data:{type:"facebook-app-request",key:resp.request,value:_this.model.get("uid")},type:"post",success:function(token){}})
}});return false}};PostView.prototype.onTweet=function(e){var hashtag,newwindow,text;text=this.model.summarizeContent("full");if(text.length>92){text=text.slice(0,92)+"..."}text=encodeURIComponent(text)+"\n  ";text+=window.location.hostname+("/"+this.model.get("uid"));hashtag=function(){switch(this.model.get("type")){case"haiku":return"haiku";case"quote":return"quote";case"free-verse":return"poetry";case"six-word-story":return"sixwordstory"}}.call(this);newwindow=window.open("https://twitter.com/share?url=''&text="+text+"&hashtags="+hashtag,"name","height=250,width=400");if(window.focus){newwindow.focus()}return false};PostView.prototype.onPin=function(e){var description,img,loc,media,summary,url;url="url="+encodeURIComponent(window.location.href);if(this.model.get("attachmentType")==="image"){img=this.model.get("attachment");if(/^\//.test(img)){img="http://"+window.location.hostname+img}media="&media="+encodeURIComponent(img)}else{media=""}summary=this.model.summarizeContent("full");if(summary.length>200){summary=summary.slice(0,200)+"..."}summary+="\n"+window.location.href;description="&description="+encodeURIComponent(summary);loc="http://pinterest.com/pin/create/button/?"+url+media+description;window.open(loc,"pinterest_popup","width=580,height=280");return false};PostView.prototype.onSaveComment=function(){var _this=this;$.ajax({url:Poe3.apiUrl("posts/"+this.model.id+"/comments"),data:{content:$(".post-view .comments textarea").val()},type:"post",success:function(comment){return _this.addComments()}});return false};PostView.prototype.onPublishClick=function(){var _this=this;return $.ajax({url:Poe3.apiUrl("posts/"+this.model.id+"/state"),data:{value:"complete"},type:"PUT",success:function(post){_this.updateParentPost(new Poe3.Post(post));_this.model.set(post);return _this.showMessage('<p class="text"><i class="icon-ok"></i> Congratulations. You have published it.</p>',"success")}})};PostView.prototype.onSubmitPartClick=function(){var content,validation,_this=this;content=$(".post-view textarea.content").val();validation=this.model.validateNewPart(content);if(validation.isValid){this.hideContentError();return $.post(Poe3.apiUrl("posts/"+this.model.id+"/parts"),{content:content},function(post){_this.updateParentPost(new Poe3.Post(post));return _this.model.set(post)})}else{return this.showContentError(validation.error)}};PostView.prototype.onRemovePartClick=function(){var self;self=this;return function(){var _this=this;return $.ajax({url:Poe3.apiUrl("posts/"+self.model.id+"/selectedparts/"+$(this).data("partid")),type:"DELETE",success:function(post){self.updateParentPost(new Poe3.Post(post));return self.model.set(post)}})}};PostView.prototype.onSelectPartClick=function(){var self;self=this;return function(){var _this=this;return $.post(Poe3.apiUrl("posts/"+self.model.id+"/selectedparts"),{id:$(this).data("partid")},function(post){self.updateParentPost(new Poe3.Post(post));return self.model.set(post)})}};PostView.prototype.onLikeClick=function(){var likeButton,loginView,_this=this;if(app.isAuthenticated()){likeButton=$(".post-view .post-buttons i.like-button");if(likeButton.hasClass("icon-heart")){return $.ajax({url:Poe3.apiUrl("posts/"+this.model.id+"/like"),type:"DELETE",success:function(post){var _post;likeButton.removeClass("icon-heart");likeButton.removeClass("icon-heart-empty");likeButton.addClass("icon-heart-empty");_post=new Poe3.Post(post);return _this.updateParentPost(_post)}})}else{return $.ajax({url:Poe3.apiUrl("posts/"+this.model.id+"/like"),type:"PUT",success:function(post){var _post;likeButton.removeClass("icon-heart");likeButton.removeClass("icon-heart-empty");likeButton.addClass("icon-heart");_post=new Poe3.Post(post);return _this.updateParentPost(_post)}})}}else{return loginView=new Poe3.LoginView}};PostView.prototype.onSettingsClick=function(){var $settings,deleteOrUnpublish,form,formContent,imageUrl,_ref,_ref1,_ref2,_ref3,_this=this;formContent="";formContent+='            <p>                Tags: <br />                <input type="text" placeholder="eg: nature,rains" class="tags" value="'+this.model.get("tags").join(",")+'" />            </p>            <p>                Notes: <br />                <textarea class="notes">'+((_ref=this.model.get("notes"))!=null?_ref:"")+"</textarea>                                    </p>";imageUrl=(_ref1=this.model.get("attachment"))!=null?_ref1:"";formContent+='            <p class="show-image-edit-form">                Do you want to <a href="#">change the image</a>?            </p>            <div class="image-edit-form hidden">                <p>                    Image (optional): <br />                    <input type="text" class="image-url" value="'+imageUrl+'" />                </p>                <p>                    Image Credits (optional):<br />                    <input type="text" class="credits-name" placeholder="eg: John Doe" value="'+((_ref2=this.model.get("attachmentCreditsName"))!=null?_ref2:"")+'" />                     <input type="text" class="credits-website" placeholder="eg: http://www.website.com" value="'+((_ref3=this.model.get("attachmentCreditsWebsite"))!=null?_ref3:"")+'" />                </p>            </div>';form='            <form class="post-settings">'+formContent+'                <p>                    <button class="save"><i class="icon-ok"></i>Save</button> or <a class="cancel" href="#">cancel</a>                </p>            </form>';if(this.model.get("state")==="complete"){deleteOrUnpublish='                <div class="delete-unpublish">                    <p>                        Do you want to <a class="unpublish-post" href="#">unpublish</a> or <a class="delete-post" href="#">delete</a> this post?                    </p>                    <p class="unpublish-post-option" style="display:none">                        <button class="unpublish-post"><i class="icon-ban-circle"></i>Unpublish</button>                    </p>                                            <p class="delete-post-option" style="display:none">                        <button class="delete-post"><i class="icon-remove"></i>Delete forever</button>                    </p>                </div>'}else{deleteOrUnpublish='                <div class="delete-unpublish">                    <p>                        Do you want to <a class="delete-post" href="#">delete</a> this post?                    </p>                    <p class="delete-post-option" style="display:none">                        <button class="delete-post"><i class="icon-remove"></i>Delete forever</button>                    </p>                </div>'}this.displayModalModal($(".post-view .post-box"),form+deleteOrUnpublish);$settings=$(".post-view .modal-modal .post-settings");$(document).bindNew("click",".post-view .modal-modal .post-settings .show-image-edit-form a",function(){$settings.find(".show-image-edit-form").hide();return $settings.find(".image-edit-form").show()});$(document).bindNew("click",".post-settings button.save",function(){var attachmentUrl,data,ext;data={tags:$settings.find("input.tags").val(),notes:$settings.find("textarea.notes").val()};attachmentUrl=$settings.find("input.image-url").val();if(attachmentUrl){ext=attachmentUrl.split("/").pop().split(".").pop().toLowerCase();if(ext==="png"||ext==="jpg"||ext==="jpeg"||ext==="gif"||ext==="bmp"){data.attachmentType="image";data.attachment=attachmentUrl;if($settings.find("input.credits-name").val()){data.attachmentCreditsName=$settings.find("input.credits-name").val();if($settings.find("input.credits-website").val()){data.attachmentCreditsWebsite=$settings.find("input.credits-website").val()}}}else{alert("Image url should end with .jpg, .jpeg or .png.");return}}else{data.attachmentType=""}return $.ajax({url:Poe3.apiUrl("posts/"+_this.model.id),data:data,type:"PUT",success:function(post){_this.closeModalModal();_this.updateParentPost(new Poe3.Post(post));_this.model.set(post);return _this.showMessage('<p class="text"><i class="icon-ok"></i> Saved.</p>',"success")}})});$(document).bindNew("click",".post-view .modal-modal .post-settings a.cancel",function(){return _this.closeModalModal()});$(document).bindNew("click",".post-view .modal-modal .delete-unpublish button.delete-post",function(){return $.ajax({url:Poe3.apiUrl("posts/"+_this.model.id),type:"DELETE",success:function(){_this.closeModalModal();_this.deleteParentPost(_this.model);return _this.showMessage('<p class="text"><i class="icon-ok"></i> Deleted. You will never see it again.</p>',"alert")}})});$(document).bindNew("click",".post-view .modal-modal .delete-unpublish button.unpublish-post",function(){return $.ajax({url:Poe3.apiUrl("posts/"+_this.model.id+"/state"),data:{value:"open"},type:"PUT",success:function(post){_this.closeModalModal();_this.updateParentPost(new Poe3.Post(post));_this.model.set(post);return _this.showMessage('<p class="text"><i class="icon-ok"></i> You have unpublished it.</p>',"alert")}})});$(document).bindNew("click",".post-view .post-box .unpublish-post",function(){$(".post-view .post-box .delete-post-option").hide();$(".post-view .post-box .unpublish-post-option").show();return false});return $(document).bindNew("click",".post-view .post-box .delete-post",function(){$(".post-view .post-box .unpublish-post-option").hide();$(".post-view .post-box .delete-post-option").show();return false})};PostView.prototype.showContentError=function(error){$(".content-error").html('<i class="icon-remove-sign"></i> '+error);return $(".content-error").show()};PostView.prototype.hideContentError=function(){return $(".content-error").hide()};PostView.prototype.updateParentPost=function(post){var index,p,_ref,_ref1;if((_ref=app.activeView)!=null){if(typeof _ref.updatePost==="function"){_ref.updatePost(post)}}if((_ref1=this.gallery)!=null?_ref1.posts.length:void 0){index=function(){var _i,_len,_ref2,_results;_ref2=this.gallery.posts;_results=[];for(index=_i=0,_len=_ref2.length;_i<_len;index=++_i){p=_ref2[index];if(p.id===post.id){_results.push(index)}}return _results}.call(this)[0];return this.gallery.posts.splice(index,1,post)}};PostView.prototype.deleteParentPost=function(post){var _ref;return(_ref=app.activeView)!=null?typeof _ref.deletePost==="function"?_ref.deletePost(post):void 0:void 0};PostView.prototype.setupModal=function(size){$(".post-view .post-frame").css("width",""+size+"px");$(".post-view .post-box").css("width",""+size+"px");$(".post-view .post-box").show();$(".post-view .post-details").css("width",""+(size-16)+"px");$(".post-view .post-details").show();$(".post-view .gallery").show();$(".post-view .gallery-nav").show();return this.displayModal()};PostView.prototype.getModalSize=function(){var height,maxWidth,minWidth,scaledWidth,width,windowHeight;minWidth=480;maxWidth=this.gallery?800:920;if(this.model.get("attachmentType")==="image"){height=$(".post-view .post-box").height();width=$(".post-view .post-box .background img")[0].naturalWidth;if($(window).width()<width+32){width=$(window).width()-32}windowHeight=$(window).height()-160;scaledWidth=parseInt(width*(windowHeight/height));if(width<scaledWidth){scaledWidth=width}if(scaledWidth>maxWidth){scaledWidth=maxWidth}if(scaledWidth<minWidth){scaledWidth=minWidth}return scaledWidth}else{return 520}};return PostView}(Poe3.ModalView);window.Poe3.PostView=PostView}).call(this);(function(){var UserView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};UserView=function(_super){__extends(UserView,_super);function UserView(domain,username,section){this.domain=domain;this.username=username;this.section=section;this.getPostByUID=__bind(this.getPostByUID,this);this.isOwnProfile=__bind(this.isOwnProfile,this);this.attachEvents=__bind(this.attachEvents,this);this.showMessages=__bind(this.showMessages,this);this.showTags=__bind(this.showTags,this);this.showLikes=__bind(this.showLikes,this);this.showOpen=__bind(this.showOpen,this);this.showCompleted=__bind(this.showCompleted,this);this.renderMessages=__bind(this.renderMessages,this);this.renderPosts=__bind(this.renderPosts,this);this.render=__bind(this.render,this);this.renderContainer=__bind(this.renderContainer,this);this.resizeOnRefresh=__bind(this.resizeOnRefresh,this);this.loadSection=__bind(this.loadSection,this);this.initialize=__bind(this.initialize,this);UserView.__super__.constructor.call(this,{model:new Poe3.User({domain:this.domain,username:this.username})})}UserView.prototype.initialize=function(){$("#content").html(this.el);this.renderContainer();this.model.bind("change",this.render,this);this.model.fetch();return this.loadSection()};UserView.prototype.loadSection=function(){switch(this.section){case"completed":return this.showCompleted();case"open":return this.showOpen();case"likes":return this.showLikes();case"tags":return this.showTags();case"messages":return this.showMessages()}};UserView.prototype.resizeOnRefresh=function(){return true};UserView.prototype.renderContainer=function(){return $(this.el).html(this.container({domain:this.domain,username:this.username}))};UserView.prototype.render=function(){var params;this.setTitle(this.model.get("name"));params=this.model.toTemplateParam();params.followerCount=params.followers.length;params.followers=params.followers.slice(0,4);params.followingCount=params.following.length;params.following=params.following.slice(0,4);params.about=window.Poe3.formatText(this.model.get("about"));params.showLinks=this.model.get("domain")!=="poe3";if(!params.about){params.about="<p>"+this.replaceWithHumor("empty-profile")+"</p>"}params.pagename=this.pagename;params.self=this.model.get("domain")===app.getUser().domain&&this.model.get("username")===app.getUser().username;$(this.el).find(".user-info").html(this.userInfo(params));if(app.isAuthenticated()){if(this.model.isFollowedBy(app.getUser().id)){$(".user-view .actions .not-following").hide();$(".user-view .actions .following").show();$(".user-view .following-mark").show()}else{$(".user-view .actions .following").hide();$(".user-view .actions .not-following").show();$(".user-view .following-mark").hide()}if(this.isOwnProfile()){$(".user-view .std-menu li.messages").removeClass("hidden")}}else{$(".user-view .actions .following").hide();$(".user-view .actions .not-following").show();$(".user-view .following-mark").hide()}this.attachEvents();return this.onRenderComplete(".user-view")};UserView.prototype.renderPosts=function(){var empty;$(".user-view .page-content").html("");if(!this.postsModel.length){empty=$('<div><p class="empty">&quot;'+this.replaceWithHumor("empty")+"&quot;</p></div>");if(this.isOwnProfile()){if(this.section==="completed"){empty.append('<p class="subtext">Just one way to fix this. Complete an <a href="/posts/open">open poem</a> or write a <a href="/posts/new">new one</a>.</p>')}else if(this.section==="open"){empty.append('<p class="subtext">Why not start a new <a href="/posts/new">collaborative poem</a>?</p>')}else if(this.section==="likes"){empty.append("<p class=\"subtext\">Tip: Click the heart-shaped icon after opening a poem to 'like' it.</p>")}}return empty.appendTo(".user-view .page-content")}else{if(this.pageContentType==="POSTS"){this.postListView=new Poe3.PostListView(".user-view .page-content","/"+this.domain+"/"+this.username,this.postsModel.toArray());return this.postListView.render()}else if(this.pageContentType==="TAG-LIST"){this.tagListView=new Poe3.TagListView(".user-view .page-content",this.postsModel.toArray());return this.tagListView.render()}}};UserView.prototype.renderMessages=function(messagesModel){var eMsg,eMsgs,eThread,eThreads,index,mailbox,messages,msg,sender,senderid,thread,threadDict,_i,_len;$(".topbar .main-message-alert").hide();$(".user-view .page-content").html("");messages=messagesModel.toArray();if(!messages.length){return $(".user-view .page-content").html('<p class="empty">There are no messages to display.</p>')}else{$(".user-view .page-content").html('                <div class="mailbox">                    <ul class="threads"></ul>                </div>');threadDict=_.groupBy(messages,function(m){return m.get("from").id});mailbox=$(".user-view .page-content .mailbox");eThreads=mailbox.find(".threads");for(senderid in threadDict){thread=threadDict[senderid];sender=thread[0].get("from");eThread=$('                    <li>                        <a href="/'+sender.domain+"/"+sender.username+'"><img src="'+sender.thumbnail+'" alt="'+sender.name+'" /></a>                        <h3><a href="/'+sender.domain+"/"+sender.username+'">'+sender.name+'</a></h3>                                       <ul class="messages"></ul>                        <div style="clear:both"></div>                    </li>');eThread.appendTo(eThreads);eMsgs=eThread.find(".messages");for(index=_i=0,_len=thread.length;_i<_len;index=++_i){msg=thread[index];if(index<3){eMsg=$("<li></li>")}else{eMsg=$('<li class="hidden"></li>')}eMsg.appendTo(eMsgs);eMsg.html(msg.toHtml())}if(thread.length>3){eThread.append('<p class="show-all"><i class="icon-plus"></i> <span class="link">Show '+(thread.length-3)+" more</span></p>");(function(eThread){return eThread.find(".show-all").click(function(){$(this).hide();return eThread.find(".messages li.hidden").show()})})(eThread)}}return Poe3.fixAnchors(eThreads)}};UserView.prototype.showCompleted=function(){$(".user-view .std-menu li a").removeClass("selected");$(".user-view .std-menu li a.completed").addClass("selected");this.pageContentType="POSTS";this.postsModel=new Poe3.Posts;this.postsModel.bind("reset",this.renderPosts,this);return this.postsModel.fetch({data:{domain:this.domain,username:this.username,state:"complete"}})};UserView.prototype.showOpen=function(){$(".user-view .std-menu li a").removeClass("selected");$(".user-view .std-menu li a.open").addClass("selected");this.pageContentType="POSTS";this.postsModel=new Poe3.Posts;this.postsModel.bind("reset",this.renderPosts,this);return this.postsModel.fetch({data:{domain:this.domain,username:this.username,state:"incomplete"}})};UserView.prototype.showLikes=function(){$(".user-view .std-menu li a").removeClass("selected");$(".user-view .std-menu li a.likes").addClass("selected");this.pageContentType="POSTS";this.postsModel=new Poe3.Posts;this.postsModel.bind("reset",this.renderPosts,this);return this.postsModel.fetch({data:{domain:this.domain,username:this.username,category:"likes"}})};UserView.prototype.showTags=function(){$(".user-view .std-menu li a").removeClass("selected");$(".user-view .std-menu li a.tags").addClass("selected");this.pageContentType="TAG-LIST";this.postsModel=new Poe3.Posts;this.postsModel.bind("reset",this.renderPosts,this);return this.postsModel.fetch({data:{domain:this.domain,username:this.username,state:"complete"}})};UserView.prototype.showMessages=function(){var messages;$(".user-view .std-menu li a").removeClass("selected");$(".user-view .std-menu li a.messages").addClass("selected");this.pageContentType="MESSAGES";messages=new Poe3.Messages;messages.bind("reset",this.renderMessages,this);messages.userid=app.getUser().id;return messages.fetch()};UserView.prototype.attachEvents=function(){var _this=this;$(document).bindNew("click",".user-view .follow .all.following",function(){var users;users=_this.model.toJSON().following;new Poe3.UserListView(users,{heading:"Following "+users.length});return false});$(document).bindNew("click",".user-view .follow .all.followers",function(){var users;users=_this.model.toJSON().followers;new Poe3.UserListView(users,{heading:""+users.length+" Followers"});return false});$(document).bindNew("click",".user-view .actions .not-following button",function(){$.post(Poe3.apiUrl("users/"+_this.model.id+"/followers"),{id:app.getUser().id},function(resp){_this.model.get("followers").push(app.getUser().id);$(".user-view .actions .not-following").hide();$(".user-view .actions .following").show();return $(".user-view .following-mark").show()});return false});$(document).bindNew("click",".user-view .actions .following button",function(){$.ajax({url:Poe3.apiUrl("users/"+_this.model.id+"/followers/"+app.getUser().id),type:"DELETE",success:function(resp){var follower;_this.model.set("following",function(){var _i,_len,_ref,_results;_ref=this.model.get("followers");_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){follower=_ref[_i];if(follower.id!==app.getUser().id){_results.push(follower)}}return _results}.call(_this));$(".user-view .actions .following").hide();$(".user-view .actions .not-following").show();return $(".user-view .following-mark").hide()}});return false});$(document).bindNew("click",".user-view .std-menu .completed",function(){app.navigate("/"+_this.domain+"/"+_this.username+"/completed",false);_this.section="completed";_this.loadSection();return false});$(document).bindNew("click",".user-view .std-menu .open",function(){app.navigate("/"+_this.domain+"/"+_this.username+"/open",false);_this.section="open";_this.loadSection();return false});$(document).bindNew("click",".user-view .std-menu .likes",function(){app.navigate("/"+_this.domain+"/"+_this.username+"/likes",false);_this.section="likes";_this.loadSection();return false});$(document).bindNew("click",".user-view .std-menu .tags",function(){app.navigate("/"+_this.domain+"/"+_this.username+"/tags",false);_this.section="tags";_this.loadSection();return false});return $(document).bindNew("click",".user-view .std-menu .messages",function(){app.navigate("/"+_this.domain+"/"+_this.username+"/messages",false);_this.section="messages";_this.loadSection();return false})};UserView.prototype.isOwnProfile=function(){return app.getUser().id===this.model.id};UserView.prototype.getPostByUID=function(uid){var matches,post,posts,_ref;posts=(_ref=this.postsModel)!=null?_ref.toArray():void 0;if(posts){matches=function(){var _i,_len,_results;_results=[];for(_i=0,_len=posts.length;_i<_len;_i++){post=posts[_i];if(post.get("uid")===uid){_results.push(post)}}return _results}();if(matches.length){return matches[0]}}};return UserView}(Poe3.PageView);window.Poe3.UserView=UserView}).call(this);(function(){var EditUserView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EditUserView=function(_super){__extends(EditUserView,_super);function EditUserView(domain,username){this.domain=domain;this.username=username;this.save=__bind(this.save,this);this.render=__bind(this.render,this);this.initialize=__bind(this.initialize,this);EditUserView.__super__.constructor.call(this,{model:new Poe3.User({domain:this.domain,username:this.username})})}EditUserView.prototype.initialize=function(){this.model.bind("change",this.render,this);return this.model.fetch()};EditUserView.prototype.render=function(){var user;this.setTitle("Editing "+this.model.get("name"));this.createModalContainer("edit-user-view-container");user=this.model.toTemplateParam();$(".edit-user-view-container").html(this.el);$(this.el).html(this.template(user));this.displayModal();$(document).bindNew("click",".edit-form button.save",this.save);return this.onRenderComplete(".edit-user-view-container")};EditUserView.prototype.save=function(){var params,user,_this=this;params={id:this.model.get("id"),about:$(".edit-user .about").val(),twitterUsername:$(".edit-user .twitter-username").val(),website:$(".edit-user .website").val()};user=new Poe3.User(params);return user.save({},{success:function(model,resp){app.activeView.model.set(resp);return _this.closeModal()}})};return EditUserView}(Poe3.ModalView);window.Poe3.EditUserView=EditUserView}).call(this);(function(){var LoginView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};LoginView=function(_super){__extends(LoginView,_super);function LoginView(loginSuccessAction,loginFailAction){this.loginSuccessAction=loginSuccessAction;this.loginFailAction=loginFailAction;this.afterClose=__bind(this.afterClose,this);this.attachEvents=__bind(this.attachEvents,this);this.render=__bind(this.render,this);LoginView.__super__.constructor.call(this);this.render();this.modalConfig.urlLess=true}LoginView.prototype.render=function(){this.setTitle("Login with Facebook");this.createModalContainer("login-view-container");$(".login-view-container").html('            <div class="main-section">                <p>                    You need to login to do that.                </p>                <img class="fb-login-button" src="/images/facebook.png" alt="FB connect" />                 <img class="twitter-login-button" src="/images/twitter.png" alt="FB connect" />             </div>');this.attachEvents();return this.displayModal()};LoginView.prototype.attachEvents=function(){var _this=this;$(".login-view-container .fb-login-button").click(function(){FB.login(function(response){_this.loginSuccess=response.status==="connected";if(_this.loginSuccess){app.login("fb",response.authResponse.accessToken)}return $(".login-view-container").trigger("close",{mustClose:true})},{scope:"email,publish_actions"});return false});return $(".login-view-container .twitter-login-button").click(function(){window.location.href="/auth/twitter";return false})};LoginView.prototype.afterClose=function(){var _this=this;return function(){if(_this.loginSuccess){return typeof _this.loginSuccessAction==="function"?_this.loginSuccessAction():void 0}else{return typeof _this.loginFailAction==="function"?_this.loginFailAction():void 0}}};return LoginView}(Poe3.ModalView);window.Poe3.LoginView=LoginView}).call(this);(function(){var FacebookSharePostView,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};FacebookSharePostView=function(_super){__extends(FacebookSharePostView,_super);function FacebookSharePostView(message,picture,postid,onSuccessCb){this.message=message;this.picture=picture;this.postid=postid;this.onSuccessCb=onSuccessCb;this.attachEvents=__bind(this.attachEvents,this);this.render=__bind(this.render,this);FacebookSharePostView.__super__.constructor.call(this);this.render();this.modalConfig.urlLess=true}FacebookSharePostView.prototype.render=function(){var numLines,picHtml;this.setTitle("Share on Facebook");this.createModalContainer("facebook-share-post-view");numLines=this.message.split("\n").length;picHtml=this.picture?'<p><img src="'+this.picture+'" /></p>':"";$(".facebook-share-post-view").html('            <div class="main-section">                <h3>Share on Facebook:</h3>                <textarea>'+this.message+"</textarea>                "+picHtml+'                <p>                    <button class="share"><i class="icon-share"></i>Share on FB</button> or <a class="cancel" href="#">cancel</a>                </p>            </div>');$(".facebook-share-post-view textarea").css("height",""+numLines*18+"px");this.attachEvents();return this.displayModal()};FacebookSharePostView.prototype.attachEvents=function(){var _this=this;$(document).bindNew("click",".facebook-share-post-view button.share",function(){$.ajax({url:Poe3.apiUrl("posts/"+_this.postid+"/fb/shares"),data:{message:$(".facebook-share-post-view textarea").val()},type:"post",success:function(resp){$(".social-share .facebook").html('<i class="icon-ok"></i> Shared on Facebook.');return _this.closeModal()}});return false});return $(document).bindNew("click",".facebook-share-post-view a.cancel",function(){_this.closeModal();return false})};return FacebookSharePostView}(Poe3.ModalView);window.Poe3.FacebookSharePostView=FacebookSharePostView}).call(this);(function(){var Notifications,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Notifications=function(){function Notifications(){this.displayBroadcasts=__bind(this.displayBroadcasts,this);this.clear=__bind(this.clear,this);this.sync=__bind(this.sync,this);this.lastSyncTime=0;this.disableSync=false;setInterval(this.sync,6e4)}Notifications.prototype.sync=function(){var _this=this;if(!this.disableSync){if(app.isAuthenticated()&&!this.showingUserNotifications||this.showingUserNotifications&&!app.isAuthenticated()){this.clear()}if(app.isAuthenticated()){this.showingUserNotifications=true;return $.get(Poe3.apiUrl("users/"+app.getUser().id+"/status?since="+this.lastSyncTime),function(resp){if(resp.userid!==app.getUser().id||resp.error==="NO_SESSION"){app.clearCookies();app.refreshApp()}if(resp.messageCount>0){$(".main-message-alert .msg-count").html(resp.messageCount);$(".main-message-alert").show()}else{$(".main-message-alert").hide()}_this.lastSyncTime=resp.lastSyncTime;return _this.displayBroadcasts(resp.broadcasts)})}else{this.showingUserNotifications=false;return $.get(Poe3.apiUrl("users/0/broadcasts?since="+this.lastSyncTime),function(resp){_this.lastSyncTime=resp.lastSyncTime;return _this.displayBroadcasts(resp.broadcasts)})}}};Notifications.prototype.clear=function(){this.lastSyncTime=0;return $(".sidebar .messages").html('            <div class="showcase"></div>            <div class="notifications"></div>')};Notifications.prototype.displayBroadcasts=function(broadcasts){var all,comparer,eMessages,elem,index,item,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4,_results;eMessages=$(".sidebar .messages");if((_ref=broadcasts.showcase)!=null?_ref.length:void 0){eMessages.find(".showcase").show();eMessages.find(".showcase").html("");this.showMessage(broadcasts.showcase[0],".showcase",eMessages)}else{eMessages.find(".showcase").hide()}all=[].concat((_ref1=broadcasts.userNotifications)!=null?_ref1:[]);all=all.concat((_ref2=broadcasts.globalNotifications)!=null?_ref2:[]);comparer=function(a,b){if(a.timestamp>b.timestamp){return-1}else if(a.timestamp<b.timestamp){return 1}else{return 0}};all.sort(comparer);if(all.length>32){all=all.slice(0,20)}_ref3=all.reverse();for(_i=0,_len=_ref3.length;_i<_len;_i++){item=_ref3[_i];this.showMessage(item,".notifications",eMessages)}_ref4=eMessages.find(".notification");_results=[];for(index=_j=0,_len1=_ref4.length;_j<_len1;index=++_j){elem=_ref4[index];if(index>32){_results.push($(elem).remove())}else{_results.push(void 0)}}return _results};Notifications.prototype.showMessage=function(item,type,parentElem){var eMsg,html,list,msg,typeElem;msg=new Poe3.Message(item);html=msg.toHtml("condensed");if(html){typeElem=parentElem.find(type);list=typeElem.find("ul");if(!list.length){list=$("<ul></ul>");list.appendTo(typeElem)}eMsg=$('<li class="notification"></li>');eMsg.attr("message-id",msg.id);eMsg.prependTo(list);eMsg.html(html);return Poe3.fixAnchors(eMsg)}};return Notifications}();window.Poe3.Notifications=Notifications}).call(this);(function(){var App,TopMenu,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};App=function(_super){__extends(App,_super);function App(){this.onInit=__bind(this.onInit,this);this.pathToUrl=__bind(this.pathToUrl,this);this.loadScript=__bind(this.loadScript,this);
this.shareOnFacebook=__bind(this.shareOnFacebook,this);this.navigate=__bind(this.navigate,this);this.clearCookies=__bind(this.clearCookies,this);this.refreshApp=__bind(this.refreshApp,this);this._loginEx=__bind(this._loginEx,this);this.logout=__bind(this.logout,this);this.login=__bind(this.login,this);this.isAuthenticated=__bind(this.isAuthenticated,this);this.getUser=__bind(this.getUser,this);this.onFBLoad=__bind(this.onFBLoad,this);this.processFBAuthResponse=__bind(this.processFBAuthResponse,this);this.requiresLogin=__bind(this.requiresLogin,this);this.defineModalRoute=__bind(this.defineModalRoute,this);this.definePageRoute=__bind(this.definePageRoute,this);this.taggedUserView=__bind(this.taggedUserView,this);this.editUser=__bind(this.editUser,this);this.userView=__bind(this.userView,this);this.postView=__bind(this.postView,this);this.newPost=__bind(this.newPost,this);this.posts=__bind(this.posts,this);this.route=__bind(this.route,this);this.initialize=__bind(this.initialize,this);this.activeView=null;this.activeModals=[];App.__super__.constructor.apply(this,arguments)}App.prototype.initialize=function(){var domain,_fn,_i,_len,_ref,_this=this;this.route("","home",function(){return _this.posts({category:"popular"})},"page");_ref=["poets","fb","tw"];_fn=function(domain){_this.route(""+domain+"/:username","userView",function(username){return _this.userView(domain,username)},"page");_this.route(""+domain+"/:username/:section","userTagsView",function(username,section){return _this.userView(domain,username,section)},"page");_this.route(""+domain+"/:username/edit","editUser",function(username){return _this.editUser(domain,username)},"modal");return _this.route(""+domain+"/:username/tagged/:tag","taggedUserView",function(username,tag){return _this.taggedUserView(domain,username,tag)},"page")};for(_i=0,_len=_ref.length;_i<_len;_i++){domain=_ref[_i];_fn(domain)}this.route("posts","posts",this.posts,"page");this.route("posts/:category","categoryPosts",function(category){return _this.posts({category:category})},"page");this.route("posts/:category/:subcategory","categoryAndSubCategoryPosts",function(category,subCategory){return _this.posts({category:category,subCategory:subCategory})},"page");this.route("posts/:category/:subcategory/tagged/:tag","categoryAndSubCategoryPostsAndTag",function(category,subCategory,tag){return _this.posts({category:category,subCategory:subCategory,tag:tag})},"page");this.route("posts/:category/tagged/:tag","taggedPostsViewWithCat",function(category,tag){return _this.posts({tag:tag,category:category})},"page");this.route("posts/tagged/:tag","taggedPostsView",function(tag){return _this.posts({tag:tag})},"page");this.route("posts/new","newPost",this.newPost,"page");this.route(/^([0-9]+)$/,"postView",this.postView,"modal");return $(document).ready(this.onInit)};App.prototype.route=function(url,name,handler,type){if(type==="page"){return App.__super__.route.call(this,url,name,this.definePageRoute(handler))}else if(type==="modal"){return App.__super__.route.call(this,url,name,this.defineModalRoute(handler))}};App.prototype.posts=function(params){return new Poe3.PostsView(params,{})};App.prototype.newPost=function(){var _this=this;return this.requiresLogin("/posts/new",function(){return new Poe3.NewPostView})};App.prototype.postView=function(uid){return new Poe3.PostView(uid)};App.prototype.userView=function(domain,username,section){if(section==null){section="completed"}return new Poe3.UserView(domain,username,section)};App.prototype.editUser=function(domain,username){var view;return view=new Poe3.EditUserView(domain,username)};App.prototype.taggedUserView=function(domain,username,tag){var posts,_this=this;posts=new Poe3.Posts;return posts.fetch({data:{domain:domain,username:username,state:"complete"},success:function(){var p,tagged,_posts;_posts=posts.toArray();tagged=function(){var _i,_len,_results;_results=[];for(_i=0,_len=_posts.length;_i<_len;_i++){p=_posts[_i];if(p.get("tags").indexOf(tag)!==-1){_results.push(p)}}return _results}();return new Poe3.PostView({mode:"gallery",data:{posts:tagged}})}})};App.prototype.definePageRoute=function(fn){var _this=this;return function(){var _ref,_ref1;if(((_ref=_this.activeView)!=null?_ref.href:void 0)===window.location.href){if($(".modal-popup").length){$(".modal-popup").trigger("close",{navigateBack:false});return _this.activeModals=[]}else if((_ref1=_this.activeView)!=null?_ref1.modalClosed:void 0){return _this.activeView.modalClosed=false}else{return fn.apply(_this,arguments)}}else{return fn.apply(_this,arguments)}}};App.prototype.defineModalRoute=function(fn){var _this=this;return function(){return fn.apply(_this,arguments)}};App.prototype.requiresLogin=function(url,loggedInAction){var loginView;if(this.isAuthenticated()){return loggedInAction()}else{if(this.fbAuthResponseReceived){return loginView=new Poe3.LoginView(loggedInAction,function(){return history.back()})}else{return this.navigate("/",true)}}};App.prototype.processFBAuthResponse=function(response,userInitiated){var _ref;this.fbAuthResponseReceived=true;if(userInitiated||((_ref=app.getUser())!=null?_ref.domain:void 0)==="fb"){if(response.status==="connected"){return this.login("fb",response.authResponse.accessToken)}else{return this.logout()}}};App.prototype.onFBLoad=function(){var _this=this;console.log("FB API loaded.");return FB.getLoginStatus(function(resp){if(!_this.fbAuthResponseReceived){return _this.processFBAuthResponse(resp,false)}})};App.prototype.getUser=function(){return{id:$.cookie("userid"),domain:$.cookie("domain"),username:$.cookie("username"),name:$.cookie("fullName"),passkey:$.cookie("passkey")}};App.prototype.isAuthenticated=function(){return this.getUser().id};App.prototype.login=function(domain,accessToken){var currentUser,_this=this;currentUser=app.getUser();return $.post(Poe3.apiUrl("sessions"),{domain:domain,accessToken:accessToken},function(resp){var options;options={};$.cookie("userid",resp.userid,options);$.cookie("domain",resp.domain,options);$.cookie("username",resp.username,options);$.cookie("fullName",resp.name,options);$.cookie("passkey",resp.passkey,options);return _this.refreshApp({skipNotifications:currentUser.passkey===resp.passkey})})};App.prototype.logout=function(){this.clearCookies();return this.refreshApp()};App.prototype._loginEx=function(resp){var options;options={};$.cookie("userid",resp.userid,options);$.cookie("domain",resp.domain,options);$.cookie("username",resp.username,options);$.cookie("fullName",resp.name,options);$.cookie("passkey",resp.passkey,options);return this.refreshApp()};App.prototype.refreshApp=function(options){if(options==null){options={}}this.topMenu.refresh();if(!options.skipNotifications){this.notifications.clear();return this.notifications.sync()}};App.prototype.clearCookies=function(){$.removeCookie("userid");$.removeCookie("domain");$.removeCookie("username");$.removeCookie("fullName");return $.removeCookie("passkey")};App.prototype.navigate=function(url,options){App.__super__.navigate.apply(this,arguments);return typeof _gaq!=="undefined"&&_gaq!==null?_gaq.push(["_trackPageview",url]):void 0};App.prototype.setAppMode=function(mode){var options;options={};return $.cookie("appMode",mode,options)};App.prototype.getAppMode=function(){return $.cookie("appMode")};App.prototype.resetAppMode=function(){return $.removeCookie("appMode")};App.prototype.shareOnFacebook=function(){var _this=this;FB.ui({method:"apprequests",display:"popup",message:"Write Poetry. Together."},function(resp){if(resp){return $.ajax({url:Poe3.apiUrl("tokens"),data:{type:"facebook-friend-invite",key:resp.request,value:window.location.href},type:"post",success:function(token){}})}});return false};App.prototype.loadScript=function(src){return $("head").append('<script src="'+src+'"></script>')};App.prototype.pathToUrl=function(path){if(/http:\/\//.test(path)||/https:\/\//.test(path)){return path}if(/^\//.test(path)){path=path.substring(1)}if(window.location.hostname==="poe3.com"){return"http://www.poe3.com/"+path}else{return"http://"+window.location.hostname+"/"+path}};App.prototype.onInit=function(){var _this=this;return Poe3.templateLoader.load("Poe3",["NewPostView","PostListView","PostListViewItem","PostsView","TagListView","TagListViewItem",{view:"PostView",templates:{template:"PostView",commentsTemplate:"PostComments"}},"UserListView",{view:"UserView",templates:{container:"UserView",userInfo:"UserInfo"}},"EditUserView"],function(){var key,queryString;queryString=Poe3.getQueryString(window.location.href);if(queryString.request_ids){key=queryString.request_ids.split(",").pop();$.get(Poe3.apiUrl("tokens/facebook-app-request/"+key),function(resp){if(resp!=null?resp.value:void 0){return window.location.href="/"+resp.value}})}$(window).resize(function(){var _ref;if((_ref=_this.activeView)!=null?typeof _ref.resizeOnRefresh==="function"?_ref.resizeOnRefresh():void 0:void 0){if(_this.lastResizedWidth){if(Math.abs($(document).width()-_this.lastResizedWidth)>32){_this.lastResizedWidth=$(document).width();return window.location.reload()}}else{return _this.lastResizedWidth=$(document).width()}}});Backbone.history=Backbone.history||new Backbone.History({});Backbone.history.start({pushState:true,root:"/"});$(".sidebar").mouseover(function(){return $(".sidebar .menu").css("opacity","1.0")}).mouseout(function(){return $(".sidebar .menu").css("opacity","0.5")});_this.topMenu=new TopMenu;_this.topMenu.refresh();window.Poe3.initFB();window.Poe3.fixAnchors(".logo");_this.notifications=new Poe3.Notifications;return _this.notifications.sync()})};return App}(Backbone.Router);window.app=new App;TopMenu=function(){function TopMenu(){this.shortenName=__bind(this.shortenName,this);this.attachHandlers=__bind(this.attachHandlers,this);this.positionMessageAlert=__bind(this.positionMessageAlert,this);this.refresh=__bind(this.refresh,this);var _this=this;$(".menu-container").html('            <ul class="menu">                <li class="new-poem"><a href="/posts/new">New Poem</a></li>                <li class="login hidden">                    <span class="txt">Login</span>                    <img class="facebook" src="/images/facebook.png" />                    <img class="twitter" src="/images/twitter.png" />                </li>                <li class="profile hidden">                    <p class="main-message-alert" style="display:none"><i class="icon-comment"></i><span class="msg-count"></span></p>                                        <a href="#" class="name"></a>                </li>                <li class="logout hidden"><i class="icon-signout"></i><a id="logout" href="#">Logout</a></li>            </ul>');$(".topbar .menu .profile .main-message-alert").click(function(){app.navigate("/"+app.getUser().domain+"/"+app.getUser().username+"/messages",true);return false})}TopMenu.prototype.refresh=function(){var profileIcon;if(app.isAuthenticated()){$(".topbar .menu .login").hide();$(".topbar .menu .profile .name").html(app.getUser().name);$(".topbar .menu .profile, .topbar .menu .logout").show();profileIcon=function(){switch(app.getUser().domain){case"fb":return"/images/facebook.png";case"tw":return"/images/twitter.png"}}();if(profileIcon){$(".topbar .menu .profile .name").css("background","url("+profileIcon+") no-repeat 0px 0px");$(".topbar .menu .profile .name").css("background-size","16px 16px")}$(".topbar .menu .profile span.icon").html(profileIcon);this.positionMessageAlert()}else{$(".topbar .menu .profile, .topbar .menu .logout").hide();$(".topbar .menu .login").show()}Poe3.fixAnchors(".topbar");return this.attachHandlers()};TopMenu.prototype.positionMessageAlert=function(){var alertPos;alertPos=$(".topbar .menu .profile .name").position().left+$(".topbar .menu .profile .name").width();return $(".main-message-alert").css("left",""+alertPos+"px")};TopMenu.prototype.attachHandlers=function(){var _this=this;$(document).bindNew("click",".topbar .menu .profile",function(){if(app.isAuthenticated()){app.navigate("/"+app.getUser().domain+"/"+app.getUser().username,true);return false}});$(document).bindNew("click",".topbar .menu .login .facebook",function(){FB.login(function(response){return app.processFBAuthResponse(response,true)},{scope:"email,publish_actions"});return false});$(document).bindNew("click",".topbar .menu .login .twitter",function(){window.location.href="/auth/twitter";return false});return $(document).bindNew("click","#logout",function(){if(app.getUser().domain==="fb"){app.logout();FB.logout(function(resp){return app.navigate("/",true)})}else{app.logout()}return false})};TopMenu.prototype.shortenName=function(name){if((name!=null?name.length:void 0)>=14){return name.substring(0,12)+".."}else{return name}};return TopMenu}();window.Poe3.apiUrl=function(url,params,options){var key,paramArray,passkey,query,val;if(params==null){params={}}if(options==null){options={api:"v1"}}if(/^\//.test(url)){url=url.substring(1)}passkey=app.getUser().passkey;if(passkey){params.passkey=passkey}if(Object.keys(params).length>0){paramArray=[];for(key in params){val=params[key];paramArray.push(""+key+"="+encodeURIComponent(val))}query=paramArray.join("&");if(/\?/.test(url)){url+="&"+query}else{url+="?"+query}}return"/api/"+options.api+"/"+url};window.Poe3.fixAnchors=function(selector){var a,anchors,_a,_i,_len,_results;anchors=$(selector).find("a");_results=[];for(_i=0,_len=anchors.length;_i<_len;_i++){_a=anchors[_i];a=$(_a);if(a.attr("fixed-anchor")!=="true"){a.attr("fixed-anchor","true");_results.push(a.click(function(e){var href;if($(this).data("fix-anchors")!==false){href=$(this).attr("href");if(href!=="#"&&!/^http:\/\//.test(href)&&!/^https:\/\//.test(href)){app.navigate(href,true);return false}}}))}else{_results.push(void 0)}}return _results};window.Poe3.getQueryString=function(url){var dict,hash,hashes,val,_i,_len;dict={};hashes=url.slice(url.indexOf("?")+1).split("&");for(_i=0,_len=hashes.length;_i<_len;_i++){val=hashes[_i];hash=val.split("=");dict[hash[0]]=decodeURIComponent(hash[1])}return dict};window.Poe3.formatText=function(text){var item,paragraphs;if(text){paragraphs=text.split("\n\n");return function(){var _i,_len,_results;_results=[];for(_i=0,_len=paragraphs.length;_i<_len;_i++){item=paragraphs[_i];_results.push("<p>"+item.replace(/\n/g,"<br />")+"</p>")}return _results}().join("")}else{return""}};window.Poe3.getHashCode=function(text){var char,hash,i,_i,_ref;hash=0;if(text.length===0){return hash}else{for(i=_i=0,_ref=text.length;_i<_ref;i=_i+=1){char=text.charCodeAt(i);hash=(hash<<5)-hash+char;hash=hash&hash}return hash}};window.Poe3.uniqueId=function(length){var id;if(length==null){length=16}id="";while(id.length<length){id+=Math.random().toString(36).substr(2)}return id.substr(0,length)};window.Poe3.clone=function(source){var obj;obj={};Poe3.extend(obj,source);return obj};window.Poe3.extend=function(target,source){var key,val,_results;_results=[];for(key in source){val=source[key];if(typeof val!=="function"){_results.push(target[key]=val)}else{_results.push(void 0)}}return _results};$.fn.bindNew=function(eventName,selector,fn){$(this).off(eventName,selector);return $(this).on(eventName,selector,fn)};$.fn._hide=function(){$(this).removeClass("visible");return $(this).addClass("hidden")};$.fn._show=function(){$(this).removeClass("hidden");return $(this).addClass("visible")}}).call(this);jQuery.fn.vintage=function(options){var r=[0,0,0,1,1,2,3,3,3,4,4,4,5,5,5,6,6,7,7,7,7,8,8,8,9,9,9,9,10,10,10,10,11,11,12,12,12,12,13,13,13,14,14,15,15,16,16,17,17,17,18,19,19,20,21,22,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40,41,42,44,45,47,48,49,52,54,55,57,59,60,62,65,67,69,70,72,74,77,79,81,83,86,88,90,92,94,97,99,101,103,107,109,111,112,116,118,120,124,126,127,129,133,135,136,140,142,143,145,149,150,152,155,157,159,162,163,165,167,170,171,173,176,177,178,180,183,184,185,188,189,190,192,194,195,196,198,200,201,202,203,204,206,207,208,209,211,212,213,214,215,216,218,219,219,220,221,222,223,224,225,226,227,227,228,229,229,230,231,232,232,233,234,234,235,236,236,237,238,238,239,239,240,241,241,242,242,243,244,244,245,245,245,246,247,247,248,248,249,249,249,250,251,251,252,252,252,253,254,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],g=[0,0,1,2,2,3,5,5,6,7,8,8,10,11,11,12,13,15,15,16,17,18,18,19,21,22,22,23,24,26,26,27,28,29,31,31,32,33,34,35,35,37,38,39,40,41,43,44,44,45,46,47,48,50,51,52,53,54,56,57,58,59,60,61,63,64,65,66,67,68,69,71,72,73,74,75,76,77,79,80,81,83,84,85,86,88,89,90,92,93,94,95,96,97,100,101,102,103,105,106,107,108,109,111,113,114,115,117,118,119,120,122,123,124,126,127,128,129,131,132,133,135,136,137,138,140,141,142,144,145,146,148,149,150,151,153,154,155,157,158,159,160,162,163,164,166,167,168,169,171,172,173,174,175,176,177,178,179,181,182,183,184,186,186,187,188,189,190,192,193,194,195,195,196,197,199,200,201,202,202,203,204,205,206,207,208,208,209,210,211,212,213,214,214,215,216,217,218,219,219,220,221,222,223,223,224,225,226,226,227,228,228,229,230,231,232,232,232,233,234,235,235,236,236,237,238,238,239,239,240,240,241,242,242,242,243,244,245,245,246,246,247,247,248,249,249,249,250,251,251,252,252,252,253,254,255],b=[53,53,53,54,54,54,55,55,55,56,57,57,57,58,58,58,59,59,59,60,61,61,61,62,62,63,63,63,64,65,65,65,66,66,67,67,67,68,69,69,69,70,70,71,71,72,73,73,73,74,74,75,75,76,77,77,78,78,79,79,80,81,81,82,82,83,83,84,85,85,86,86,87,87,88,89,89,90,90,91,91,93,93,94,94,95,95,96,97,98,98,99,99,100,101,102,102,103,104,105,105,106,106,107,108,109,109,110,111,111,112,113,114,114,115,116,117,117,118,119,119,121,121,122,122,123,124,125,126,126,127,128,129,129,130,131,132,132,133,134,134,135,136,137,137,138,139,140,140,141,142,142,143,144,145,145,146,146,148,148,149,149,150,151,152,152,153,153,154,155,156,156,157,157,158,159,160,160,161,161,162,162,163,164,164,165,165,166,166,167,168,168,169,169,170,170,171,172,172,173,173,174,174,175,176,176,177,177,177,178,178,179,180,180,181,181,181,182,182,183,184,184,184,185,185,186,186,186,187,188,188,188,189,189,189,190,190,191,191,192,192,193,193,193,194,194,194,195,196,196,196,197,197,197,198,199];var defaultOptions={vignette:{black:.6,white:.1},noise:20,screen:{red:227,green:12,blue:169,strength:.1},desaturate:false,allowMultiEffect:false,mime:"image/jpeg",viewFinder:false};var greenOptions={vignette:{black:.6,white:.1},noise:20,screen:{red:255,green:255,blue:0,strength:.1},desaturate:false,allowMultiEffect:false,mime:"image/jpeg",viewFinder:false};var grayscaleOptions={vignette:{black:.7,white:.2},noise:25,screen:false,desaturate:1,allowMultiEffect:false,mime:"image/jpeg",viewFinder:false};var sepiaOptions={vignette:{black:.6,white:.1},noise:25,screen:{red:141,green:107,blue:3,strength:.47},desaturate:.7,allowMultiEffect:false,mime:"image/jpeg",viewFinder:false};var customOptions={vignette:false,noise:false,screen:false,desaturate:false,allowMultiEffect:true,mime:"image/jpeg",viewFinder:false};options=options||{};options.preset=options.preset||"default";switch(options.preset){case"custom":options=jQuery.extend(customOptions,options);break;case"green":options=jQuery.extend(greenOptions,options);break;case"sepia":options=jQuery.extend(sepiaOptions,options);break;case"grayscale":options=jQuery.extend(grayscaleOptions,options);break;default:options=jQuery.extend(defaultOptions,options);break}return this.each(function(){var obj=jQuery(this),ctx,canvas,loader;if(!obj.is("img")){return}if(options.allowMultiEffect===false){if(obj.data("vintage-applied")!==true){obj.data("vintage-applied",true)}else{return}}var initVintage=function(){var pos=obj.offset();pos.top+=Math.round(obj.height()/2);pos.left+=Math.round(obj.width()/2);loader=jQuery('<div class="vintage-loader">Loading&hellip;</div>');loader.css("top",pos.top+"px").css("left",pos.left+"px").hide().appendTo("body").fadeTo(0,.8,function(){process()})};var process=function(){canvas=jQuery("<canvas></canvas>").get(0);if(!canvas.getContext){loader.addClass("error").html("Your browser does not support the canvas element.").animate({opacity:"+=0"},3e3,function(){$(this).fadeOut(300,function(){$(this).remove()})})}else{ctx=canvas.getContext("2d");var image=new Image;image.src=obj.attr("src");image.onload=function(){canvas.width=this.width;canvas.height=this.height;ctx.drawImage(this,0,0,this.width,this.height,0,0,canvas.width,canvas.height);if(options.vignette!==false){addVignetteEffect()}manipulatePixels(function(){obj.attr("src",canvas.toDataURL(options.mime));loader.remove();if(typeof options.callback=="function"){options.callback()}})}}};var addVignetteEffect=function(){var gradient;var outerRadius=Math.sqrt(Math.pow(canvas.width/2,2)+Math.pow(canvas.height/2,2));ctx.globalCompositeOperation="source-over";gradient=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,outerRadius);gradient.addColorStop(0,"rgba(0,0,0,0)");gradient.addColorStop(.65,"rgba(0,0,0,0)");gradient.addColorStop(1,"rgba(0,0,0,"+options.vignette.black+")");ctx.fillStyle=gradient;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.globalCompositeOperation="lighter";gradient=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,outerRadius);gradient.addColorStop(0,"rgba(255,255,255,"+options.vignette.white+")");gradient.addColorStop(.65,"rgba(255,255,255,0)");gradient.addColorStop(1,"rgba(0,0,0,0)");ctx.fillStyle=gradient;ctx.fillRect(0,0,canvas.width,canvas.height)};var manipulatePixels=function(callback){var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);for(var i=0;i<imageData.data.length;i+=4){if(options.desaturate!==false){var average=(r[imageData.data[i]]+g[imageData.data[i+1]]+b[imageData.data[i+2]])/3;imageData.data[i]+=Math.round((average-imageData.data[i])*options.desaturate);imageData.data[i+1]+=Math.round((average-imageData.data[i+1])*options.desaturate);imageData.data[i+2]+=Math.round((average-imageData.data[i+2])*options.desaturate)}else{imageData.data[i]=r[imageData.data[i]];imageData.data[i+1]=g[imageData.data[i+1]];imageData.data[i+2]=b[imageData.data[i+2]]}if(options.screen!==false){imageData.data[i]=255-(255-imageData.data[i])*(255-options.screen.red*options.screen.strength)/255;imageData.data[i+1]=255-(255-imageData.data[i+1])*(255-options.screen.green*options.screen.strength)/255;imageData.data[i+2]=255-(255-imageData.data[i+2])*(255-options.screen.blue*options.screen.strength)/255}if(options.noise>0){var noise=Math.round(options.noise-Math.random()*options.noise/2);var dblHlp=0;for(var k=0;k<3;k++){dblHlp=noise+imageData.data[i+k];imageData.data[i+k]=dblHlp>255?255:dblHlp<0?0:dblHlp}}}if(options.viewFinder!==false){var img=new Image;img.src=options.viewFinder;img.onload=function(){var viewFinderCanvas=jQuery("<canvas></canvas>").get(0);var viewFinderCtx=viewFinderCanvas.getContext("2d");viewFinderCanvas.width=canvas.width;viewFinderCanvas.height=canvas.height;viewFinderCtx.drawImage(this,0,0,this.width,this.height,0,0,canvas.width,canvas.height);var viewFinderImageData=viewFinderCtx.getImageData(0,0,canvas.width,canvas.height);for(var a=0;a<imageData.data.length;a+=4){var red=imageData.data[a]*viewFinderImageData.data[a]/255;imageData.data[a]=red>255?255:red<0?0:red;var green=imageData.data[a+1]*viewFinderImageData.data[a+1]/255;imageData.data[a+1]=green>255?green:green<0?0:green;var blue=imageData.data[a+2]*viewFinderImageData.data[a+2]/255;imageData.data[a+2]=blue>255?255:blue<0?0:blue}ctx.putImageData(imageData,0,0);callback()}}else{ctx.putImageData(imageData,0,0);callback()}};initVintage()})};